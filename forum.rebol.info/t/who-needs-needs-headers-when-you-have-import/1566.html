<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Who needs NEEDS: headers when you have IMPORT? - Modules - AltRebol</title>
    <meta name="description" content="There&amp;#39;s a concept that seems to have been in the module design that if you put the NEEDS of your code as part of the header. 
But you run into a bit of trouble if you want to do some kind of programmatic inclusion: 
if &amp;quot;&amp;hellip;">
    <meta name="generator" content="Discourse 2.7.0.beta4 - https://github.com/discourse/discourse version 3fc72543de22c329cf2156f28b781821adc496ae">
<link rel="icon" type="image/png" href="../../uploads/default/optimized/1X/cbd70027b53fa165575e5b665f00eb3b8ae7ea31_2_32x32.ico">
<link rel="apple-touch-icon" type="image/png" href="../../uploads/default/optimized/1X/ae4ccad1a2789bb1e85cf5a0f52f2f1de10da26d_2_180x180.png">
<meta name="theme-color" content="#ffffff">
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, user-scalable=yes, viewport-fit=cover">
<link rel="canonical" href="1566.html" />
<script type="application/ld+json">{"@context":"http://schema.org","@type":"WebSite","url":"https://forum.rebol.info","potentialAction":{"@type":"SearchAction","target":"https://forum.rebol.info/search?q={search_term_string}","query-input":"required name=search_term_string"}}</script>
<link rel="search" type="application/opensearchdescription+xml" href="../../opensearch.xml" title="AltRebol Search">

      <link href="https://forum.rebol.info/stylesheets/desktop_e71c7b3a0694e7f6434c54a663bfb42821f8bd81.css?__ws=forum.rebol.info" media="all" rel="stylesheet" data-target="desktop" />
    
    
        <link rel="alternate" type="application/rss+xml" title="RSS feed of &#39;Who needs NEEDS: headers when you have IMPORT?&#39;" href="1566.rss" />
    <meta property="og:site_name" content="AltRebol" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:image" content="https://forum.rebol.info/uploads/default/original/1X/ae4ccad1a2789bb1e85cf5a0f52f2f1de10da26d.png" />
<meta property="og:image" content="https://forum.rebol.info/uploads/default/original/1X/ae4ccad1a2789bb1e85cf5a0f52f2f1de10da26d.png" />
<meta property="og:url" content="https://forum.rebol.info/t/who-needs-needs-headers-when-you-have-import/1566" />
<meta name="twitter:url" content="https://forum.rebol.info/t/who-needs-needs-headers-when-you-have-import/1566" />
<meta property="og:title" content="Who needs NEEDS: headers when you have IMPORT?" />
<meta name="twitter:title" content="Who needs NEEDS: headers when you have IMPORT?" />
<meta property="og:description" content="There&#39;s a concept that seems to have been in the module design that if you put the NEEDS of your code as part of the header.  But you run into a bit of trouble if you want to do some kind of programmatic inclusion:  if &quot;use-foo-version&quot; = getenv &quot;WHICH_FOO&quot; [     utils: import &lt;foo&gt; ] else [     utils: import &lt;bar&gt; ]  Because you&#39;re going to have a desire for this level of control, I don&#39;t really understand exactly what role the header and Needs: should be playing in module dependencies.  One po..." />
<meta name="twitter:description" content="There&#39;s a concept that seems to have been in the module design that if you put the NEEDS of your code as part of the header.  But you run into a bit of trouble if you want to do some kind of programmatic inclusion:  if &quot;use-foo-version&quot; = getenv &quot;WHICH_FOO&quot; [     utils: import &lt;foo&gt; ] else [     utils: import &lt;bar&gt; ]  Because you&#39;re going to have a desire for this level of control, I don&#39;t really understand exactly what role the header and Needs: should be playing in module dependencies.  One po..." />
<meta name="twitter:label1" value="Reading time" />
<meta name="twitter:data1" value="1 mins ðŸ•‘" />
<meta name="twitter:label2" value="Likes" />
<meta name="twitter:data2" value="4 â¤" />
<meta property="article:published_time" content="2021-03-19T12:39:20+00:00" />
<meta property="og:ignore_canonical" content="true" />



    
  </head>
  <body class="crawler">
    
    <header>
      <a href="https://forum.rebol.info/">
          <img src="../../uploads/default/original/1X/ae4ccad1a2789bb1e85cf5a0f52f2f1de10da26d.png" alt="AltRebol" id="site-logo" style="max-width: 150px;">
      </a>
    </header>
    <div id="main-outlet" class="wrap">
        <div id="topic-title">
    <h1>
      <a href="1566.html">Who needs NEEDS: headers when you have IMPORT?</a>
    </h1>

      <div class="topic-category" itemscope itemtype="http://schema.org/BreadcrumbList">
          <span itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
            <a href="https://forum.rebol.info/c/development/8" class="badge-wrapper bullet" itemprop="item">
              <span class='badge-category-bg' style='background-color: #25AAE2'></span>
              <span class='badge-category clear-badge'>
                <span class='category-name' itemprop='name'>Development</span>
              </span>
            </a>
            <meta itemprop="position" content="1" />
          </span>
          <span itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
            <a href="https://forum.rebol.info/c/development/modules/21" class="badge-wrapper bullet" itemprop="item">
              <span class='badge-category-bg' style='background-color: #25AAE2'></span>
              <span class='badge-category clear-badge'>
                <span class='category-name' itemprop='name'>Modules</span>
              </span>
            </a>
            <meta itemprop="position" content="2" />
          </span>
      </div>

  </div>

  


      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="http://schema.org/Organization">
            <meta itemprop='name' content='AltRebol'>
              <div itemprop='logo' itemscope itemtype="http://schema.org/ImageObject">
                <meta itemprop='url' content='https://forum.rebol.info/uploads/default/original/1X/ae4ccad1a2789bb1e85cf5a0f52f2f1de10da26d.png'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
            <a itemprop="url" href='https://forum.rebol.info/u/hostilefork'><span itemprop='name'>hostilefork</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="1566.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2021-03-19T12:39:20Z' class='post-time'>
                March 19, 2021, 12:39pm
              </time>
              <meta itemprop='dateModified' content='2021-03-19T12:39:20Z'>
          <span itemprop='position'>#1</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <p>There's a concept that seems to have been in the module design that if you put the NEEDS of your code as part of the header.</p>
<p>But you run into a bit of trouble if you want to do some kind of programmatic inclusion:</p>
<pre><code>if "use-foo-version" = getenv "WHICH_FOO" [
    utils: import &lt;foo&gt;
] else [
    utils: import &lt;bar&gt;
]
</code></pre>
<p><strong>Because you're going to have a desire for this level of control, I don't really understand exactly what role the header and Needs: should be playing in module dependencies.</strong></p>
<p>One possible reason it had been put in the header is because of the fact that you <a href="../slipping-bindings-into-a-module/1565.html">lose all your binding</a>, this would be the only chance you had to get bindings to the exports of the library on the code in the body.</p>
<p>But with <a href="../the-sea-of-words/1564.html"><strong>Sea of Words</strong></a> you don't have this one chance in the hands of the MODULE-running to bind the body.  You get <em>all</em> the words bound writable to the module, and readably from the modules it inherits (e.g. LIB).</p>
<p>That means IMPORT has the power to make declarations appear and link up to the code in the body.  Assuming it knows what module it's importing to.</p>
<p><em>(This means IMPORT needs to be "definitionally" defined, like RETURN is.  EXPORT needs that as well.  e.g. they are different specializations of importation for each module.)</em></p>
<h2>I'm Going to Drop NEEDS for the Moment</h2>
<p>In order to be able to focus on getting at least one thing working right, I'm going to dig into IMPORT and EXPORT.</p>
<p>When we better understand what the header form is for, we can add it back.</p>
<p>Here is DO-NEEDS at time of writing (and it has dated concepts in it like /NO-LIB and /NO-USER, these ideas are going away with a rule of all modules being isolated):</p>
<pre><code>do-needs: function [
    {Process the NEEDS block of a program header. Returns unapplied mixins.}

    needs "Needs block, header or version"
        [block! object! tuple! blank!]  ; has to handle blank! if in object!
    /no-lib "Don't export to the runtime library"
    /no-user "Don't export to the user context (mixins returned)"
    /block "Return all the imported modules in a block, instead"
][
    ; This is a low-level function and its use and return values reflect that.
    ;
    ; In user mode, the mixins are applied by IMPORT, so they don't need to
    ; be returned. In /NO-USER mode the mixins are collected into an object
    ; and returned, if the object isn't empty. This object can then be passed
    ; to MAKE module! to be applied there.
    ;
    ; The /BLOCK option returns a block of all the modules imported, not any
    ; mixins.  This is for when IMPORT is called with a `Needs: [...]` block.

    if object? needs [  ; header object
        needs: select needs 'needs  ; (protected)
    ]

    switch type of needs [
        blank! [return blank]  ; may have come from SELECT, not just arg

        tuple! [  ; simple version number check for interpreter itself
            case [
                needs &gt; system/version [
                    cause-error 'syntax 'needs reduce ['core needs]
                ]

                3 &gt;= length of needs [  ; no platform id
                    blank
                ]

                (needs and+ 0.0.0.255.255)
                &lt;&gt; (system/version and+ 0.0.0.255.255) [
                    cause-error 'syntax 'needs reduce ['core needs]
                ]
            ]
            return blank
        ]

        block! [
            if empty? needs [return blank]
        ]
    ] else [
        needs: reduce [needs]  ; If it's an inline value, put it in a block
    ]

    ; Parse the needs dialect [source &lt;version&gt;]

    mods: make block! length of needs
    name: vers: hash: _
    parse ensure block! needs [
        here:
        opt [opt 'core set vers tuple! (do-needs vers)]
        any [
            here:
            set name [word! | file! | url! | tag!]
            set vers opt tuple!
            set hash opt binary!
            (append mods reduce [name vers hash])
        ]
        end
    ] else [
        cause-error 'script 'invalid-arg here
    ]

    ; Temporary object to collect exports of "mixins" (private modules).
    ; Don't bother if returning all the modules in a block, or if in user mode.
    ;
    if no-user and (not block) [
        mixins: make object! 0  ; Minimal length since it may persist later
    ]

    ; Import the modules:
    ;
    mods: map-each [name vers hash] mods [
        mod: applique :import [
            module: name

            version: true  ; !!! automatic from VERS?
            ver: opt vers

            no-lib: no-lib
            no-user: no-user
        ]

        ; Collect any mixins into the object (if we are doing that)
        if all [set? 'mixins, mixin? mod] [
            resolve/extend/only mixins mod select meta-of mod 'exports
        ]
        mod
    ]

    return try case [
        block [mods]  ; /BLOCK refinement asks for block of modules
        not empty? to-value :mixins [mixins]  ; if any mixins, return them
    ]
]</code></pre>
        </div>

        <meta itemprop='headline' content='Who needs NEEDS: headers when you have IMPORT?'>
          <meta itemprop='keywords' content=''>

        <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="3" />
           <span class='post-likes'>3 Likes</span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="0" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="http://schema.org/Organization">
            <meta itemprop='name' content='AltRebol'>
              <div itemprop='logo' itemscope itemtype="http://schema.org/ImageObject">
                <meta itemprop='url' content='https://forum.rebol.info/uploads/default/original/1X/ae4ccad1a2789bb1e85cf5a0f52f2f1de10da26d.png'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
            <a itemprop="url" href='../../u/iArnold.html'><span itemprop='name'>iArnold</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="1566.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2021-03-19T13:48:31Z' class='post-time'>
                March 19, 2021,  1:48pm
              </time>
              <meta itemprop='dateModified' content='2021-03-19T13:48:31Z'>
          <span itemprop='position'>#2</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <p>Having this "needs:" inside the header, has always struck me as something odd about Rebol. The header block is used for clarifying and meta info and suddenly there is NEEDS and it forces the things it needs to be available. It looks inside the header like it is just another description but it turns out to be REAL code, next to many other items that could just as well be left out.<br>
So having NEEDS as an alias for IMPORT and solving the dependencies in some other way... I say +1 from me.</p>
        </div>

        <meta itemprop='headline' content='Who needs NEEDS: headers when you have IMPORT?'>

        <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="1" />
           <span class='post-likes'>1 Like</span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="0" />
          </div>

      </div>






    </div>
    <footer class="container wrap">
      <nav class='crawler-nav'>
        <ul>
        <li itemscope itemtype='http://schema.org/SiteNavigationElement'>
          <span itemprop='name'>
            <a href='https://forum.rebol.info/' itemprop="url">Home </a>
          </span>
        </li>
        <li itemscope itemtype='http://schema.org/SiteNavigationElement'>
          <span itemprop='name'>
            <a href='https://forum.rebol.info/categories' itemprop="url">Categories </a>
          </span>
        </li>
        <li itemscope itemtype='http://schema.org/SiteNavigationElement'>
          <span itemprop='name'>
            <a href='https://forum.rebol.info/guidelines' itemprop="url">FAQ/Guidelines </a>
          </span>
        </li>
        <li itemscope itemtype='http://schema.org/SiteNavigationElement'>
          <span itemprop='name'>
            <a href='https://forum.rebol.info/tos' itemprop="url">Terms of Service </a>
          </span>
        </li>
        <li itemscope itemtype='http://schema.org/SiteNavigationElement'>
          <span itemprop='name'>
            <a href='https://forum.rebol.info/privacy' itemprop="url">Privacy Policy </a>
          </span>
        </li>
        </ul>
      </nav>
      <p class='powered-by-link'>Powered by <a href="https://www.discourse.org">Discourse</a>, best viewed with JavaScript enabled</p>
    </footer>
    
    
  </body>
  
</html>
