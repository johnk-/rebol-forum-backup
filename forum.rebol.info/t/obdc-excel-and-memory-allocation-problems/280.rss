<?xml version="1.0" encoding="UTF-8" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:dc="http://purl.org/dc/elements/1.1/">
  <channel>
    <title>OBDC, Excel and memory allocation problems</title>
    <link>https://forum.rebol.info/t/obdc-excel-and-memory-allocation-problems/280</link>
    <description>**Error: Couldn&#39;t allocate column buffer**

Hi there! First time posting on a Rebol/Ren-C/Red forum, I hope this is the right place for my question. I have been testing the ODBC functionality in *Ren-C build 2.102.0.3.1* from **10-Aug-2017/5:25:53** on Windows 10 Pro.

Is there any way how to increase the available memory for the ODBC query? Because I have some kind of memory allocation problem while running my queries..

    &gt;&gt; insert conn-port &quot;select * from [Sheet0$] where Meno = &#39;ALENA&#39;&quot;
    ** Error: Couldn&#39;t allocate column buffer!
    ** Where: insert-odbc --anonymous-- insert
    ** Near: reduce compose [(sql)] ??

The query should return 1 record from an XLSX file with 13 columns, where 2 of the columns contain strings longer than 1500 characters. When I run the select query without these two columns the query runs fine and I receive my data.

I am a bit confused with this problem because in Rebol2/View I can run the same query with all 100 records (without the `where` clause) in a single statement without any memory problems. Am I missing something or is it a bug in the ODBC Ren-C implementation? Thank you very much for an answer and for your excellent work.

P.S. running TRACE ON crashes the executable immediately..</description>
    
    <lastBuildDate>Sat, 16 Sep 2017 09:34:27 +0000</lastBuildDate>
    <category>Databases</category>
    <atom:link href="https://forum.rebol.info/t/obdc-excel-and-memory-allocation-problems/280.rss" rel="self" type="application/rss+xml" />
      <item>
        <title>OBDC, Excel and memory allocation problems</title>
        <dc:creator><![CDATA[gchiu]]></dc:creator>
        <description><![CDATA[
            <p>These are the listed ODBC bugs <a href="https://github.com/metaeducation/ren-c/issues?utf8=%E2%9C%93&amp;q=is%3Aissue%20is%3Aopen%20odbc" rel="nofollow noopener">I found</a>.  If you've found another, please report it so that it can be eventually fixed.</p>
          <p><a href="https://forum.rebol.info/t/obdc-excel-and-memory-allocation-problems/280/20">Read full topic</a></p>
        ]]></description>
        <link>https://forum.rebol.info/t/obdc-excel-and-memory-allocation-problems/280/20</link>
        <pubDate>Sat, 16 Sep 2017 09:34:27 +0000</pubDate>
        <guid isPermaLink="false">forum.rebol.info-post-280-20</guid>
        <source url="https://forum.rebol.info/t/obdc-excel-and-memory-allocation-problems/280.rss">OBDC, Excel and memory allocation problems</source>
      </item>
      <item>
        <title>OBDC, Excel and memory allocation problems</title>
        <dc:creator><![CDATA[hostilefork]]></dc:creator>
        <description><![CDATA[
            <aside class="quote no-group" data-post="18" data-topic="280">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="//forum.rebol.info/user_avatar/forum.rebol.info/orr721/40/235_2.png" class="avatar"> orr721:</div>
<blockquote>
<p>This warning is displayed after the r3 runtime quits.</p>
</blockquote>
</aside>
<aside class="quote no-group" data-post="18" data-topic="280">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="//forum.rebol.info/user_avatar/forum.rebol.info/orr721/40/235_2.png" class="avatar"> orr721:</div>
<blockquote>
<p>Could it be because of the -debug compile?</p>
</blockquote>
</aside>
<p>Yes: the memory balancing is <a href="https://github.com/metaeducation/ren-c/blob/e6718d6e36fdc11dfaba586dd4920d906cce0b40/src/core/m-pools.c#L396" rel="nofollow noopener">only checked in the debug build</a>, and program termination is the only time you can be sure the memory isn't being held onto for later use.  A 32-bit debug build would have the same issue.</p>
<p>If you're only getting the message when you've run an ODBC query, then that's where the problem nearly certainly is.</p>
          <p><a href="https://forum.rebol.info/t/obdc-excel-and-memory-allocation-problems/280/19">Read full topic</a></p>
        ]]></description>
        <link>https://forum.rebol.info/t/obdc-excel-and-memory-allocation-problems/280/19</link>
        <pubDate>Wed, 06 Sep 2017 21:22:41 +0000</pubDate>
        <guid isPermaLink="false">forum.rebol.info-post-280-19</guid>
        <source url="https://forum.rebol.info/t/obdc-excel-and-memory-allocation-problems/280.rss">OBDC, Excel and memory allocation problems</source>
      </item>
      <item>
        <title>OBDC, Excel and memory allocation problems</title>
        <dc:creator><![CDATA[orr721]]></dc:creator>
        <description><![CDATA[
            <p>This warning is displayed <strong>after the r3 runtime quits</strong>.</p>
<p>I was not doing anything fancy really, just run the r3-... exe REPL, opened the ODBC connection, run a simple query, closed the connection and quit. It did not crash, freeze or anything.</p>
<p>And it is only displayed by the 64bit r3-...exe. Could it be because of the -debug compile? The 32bit runtime does not have this message.</p>
          <p><a href="https://forum.rebol.info/t/obdc-excel-and-memory-allocation-problems/280/18">Read full topic</a></p>
        ]]></description>
        <link>https://forum.rebol.info/t/obdc-excel-and-memory-allocation-problems/280/18</link>
        <pubDate>Wed, 06 Sep 2017 18:24:53 +0000</pubDate>
        <guid isPermaLink="false">forum.rebol.info-post-280-18</guid>
        <source url="https://forum.rebol.info/t/obdc-excel-and-memory-allocation-problems/280.rss">OBDC, Excel and memory allocation problems</source>
      </item>
      <item>
        <title>OBDC, Excel and memory allocation problems</title>
        <dc:creator><![CDATA[hostilefork]]></dc:creator>
        <description><![CDATA[
            <aside class="quote no-group" data-post="16" data-topic="280">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="//forum.rebol.info/user_avatar/forum.rebol.info/orr721/40/235_2.png" class="avatar"> orr721:</div>
<blockquote>
<p>I can test further if you give me any instructions.</p>
</blockquote>
</aside>
<p>I'm not surprised there are presently leaks in the ODBC.  It really was just a first cut at taking Christian's code and getting it to build and do <em>something</em>.</p>
<p>I'm more surprised you've managed to accomplish productive work with it.  <img src="//forum.rebol.info/images/emoji/twitter/slight_smile.png?v=7" title=":slight_smile:" class="emoji" alt=":slight_smile:"></p>
<p>At this moment there are several higher priorities in the core, but if you're blocked by an issue please bring it up.  If your code is open source, it would also be interesting to see what you're doing and perhaps suggest how you could take advantage of new features.</p>
          <p><a href="https://forum.rebol.info/t/obdc-excel-and-memory-allocation-problems/280/17">Read full topic</a></p>
        ]]></description>
        <link>https://forum.rebol.info/t/obdc-excel-and-memory-allocation-problems/280/17</link>
        <pubDate>Wed, 06 Sep 2017 17:08:38 +0000</pubDate>
        <guid isPermaLink="false">forum.rebol.info-post-280-17</guid>
        <source url="https://forum.rebol.info/t/obdc-excel-and-memory-allocation-problems/280.rss">OBDC, Excel and memory allocation problems</source>
      </item>
      <item>
        <title>OBDC, Excel and memory allocation problems</title>
        <dc:creator><![CDATA[orr721]]></dc:creator>
        <description><![CDATA[
            <p>Thanks a lot, it is working now. <img src="//forum.rebol.info/images/emoji/twitter/grinning.png?v=7" title=":grinning:" class="emoji" alt=":grinning:"></p>
<p>I have even got it running under both the 32bit and 64bit versions (had to do some black magic first to have both versions of the ODBC drivers installed at the same time).</p>
<p>A minor nitpick is that the 64bit r3-e6718d6-debug.exe version reports a memory leak? after quitting:</p>
<pre><code>&gt;&gt; close c
&gt;&gt; close p

&gt;&gt; quit
*** PG_Mem_Usage = 136436 ***
Memory accounting imbalance: Rebol internally tracks how much
memory it uses to know when to garbage collect, etc.  For
some reason this accounting did not balance to zero on exit.
Run under Valgrind with --leak-check=full --track-origins=yes
to find out why this is happening.
</code></pre>
<p>I can test further if you give me any instructions.</p>
          <p><a href="https://forum.rebol.info/t/obdc-excel-and-memory-allocation-problems/280/16">Read full topic</a></p>
        ]]></description>
        <link>https://forum.rebol.info/t/obdc-excel-and-memory-allocation-problems/280/16</link>
        <pubDate>Wed, 06 Sep 2017 15:09:45 +0000</pubDate>
        <guid isPermaLink="false">forum.rebol.info-post-280-16</guid>
        <source url="https://forum.rebol.info/t/obdc-excel-and-memory-allocation-problems/280.rss">OBDC, Excel and memory allocation problems</source>
      </item>
      <item>
        <title>OBDC, Excel and memory allocation problems</title>
        <dc:creator><![CDATA[hostilefork]]></dc:creator>
        <description><![CDATA[
            <aside class="quote no-group" data-username="orr721" data-post="14" data-topic="280">
<div class="title">
<div class="quote-controls"></div>
<img alt="" width="20" height="20" src="https://forum.rebol.info/user_avatar/forum.rebol.info/orr721/40/235_2.png" class="avatar"> orr721:</div>
<blockquote>
<p>According to Microsoft ODBC sqlext.h header file, the SQL_DATA_TYPE -1 corresponds to SQL_LONGVARCHAR. This data-type has no fixed length limit, hence the ODBC reported BUFFER_LENGTH and COLUMN_SIZE of 1073741824 (which equals 1 GB).</p>
</blockquote>
</aside>
<p>Great, thanks for looking at it and into the code itself...if people are willing to do more of that, I'm sure all this could be improved much faster!  <a href="https://github.com/metaeducation/ren-c/commit/e6718d6e36fdc11dfaba586dd4920d906cce0b40">I've committed a change</a>.</p>
<p>The Ren-C download page's HTML isn't getting updated right now, as <a class="mention" href="/u/gchiu">@gchiu</a> is in China and is firewalled out of the place where he runs the script.  But the builds are being generated by Travis anyway, and are available by URL...if you just put the commit hash in.  e.g. if you were downloading Windows 64-bit debug, the now-outdated last link that was at on the page is:</p>
<p><a href="http://metaeducation.s3.amazonaws.com/travis-builds/0.3.40/r3-a0b5b94-debug.exe" class="onebox" target="_blank" rel="noopener">http://metaeducation.s3.amazonaws.com/travis-builds/0.3.40/r3-a0b5b94-debug.exe</a></p>
<p>But the shortened hash of the commit above (e6718d6) can be substituted:</p>
<p><a href="http://metaeducation.s3.amazonaws.com/travis-builds/0.3.40/r3-e6718d6-debug.exe" class="onebox" target="_blank" rel="noopener">http://metaeducation.s3.amazonaws.com/travis-builds/0.3.40/r3-e6718d6-debug.exe</a></p>
<p><em>(Builds should be available after all their Travis entries complete, which can take some time as the Mac builds often wait in a queue.)</em></p>
<p>Of course if people build the system themselves, then they can start making patches, and I'd argue we're doing a reasonable job of keeping it the kind of C you can read with one book's worth of knowledge.  <img src="https://forum.rebol.info/images/emoji/twitter/slight_smile.png?v=9" title=":slight_smile:" class="emoji" alt=":slight_smile:"></p>
<aside class="onebox wikipedia">
  <header class="source">
      <a href="https://en.wikipedia.org/wiki/The_C_Programming_Language" target="_blank" rel="noopener">en.wikipedia.org</a>
  </header>
  <article class="onebox-body">
    <div class="aspect-image" style="--aspect-ratio:220/309;"><img src="//upload.wikimedia.org/wikipedia/commons/thumb/0/0e/The_C_Programming_Language%2C_First_Edition_Cover.svg/220px-The_C_Programming_Language%2C_First_Edition_Cover.svg.png" class="thumbnail" width="220" height="309"></div>

<h3><a href="https://en.wikipedia.org/wiki/The_C_Programming_Language" target="_blank" rel="noopener">The C Programming Language</a></h3>

<p>The C Programming Language (sometimes termed K&amp;R, after its authors' initials) is a computer programming book written by Brian Kernighan and Dennis Ritchie, the latter of whom originally designed and implemented the language, as well as co-designed the Unix operating system with which development of the language was closely intertwined.  The book was central to the development and popularization of the C programming language and is still widely read and used today.  Because the book was co-author...</p>

  </article>
  <div class="onebox-metadata">
    
    
  </div>
  <div style="clear: both"></div>
</aside>

          <p><a href="https://forum.rebol.info/t/obdc-excel-and-memory-allocation-problems/280/15">Read full topic</a></p>
        ]]></description>
        <link>https://forum.rebol.info/t/obdc-excel-and-memory-allocation-problems/280/15</link>
        <pubDate>Wed, 06 Sep 2017 00:14:22 +0000</pubDate>
        <guid isPermaLink="false">forum.rebol.info-post-280-15</guid>
        <source url="https://forum.rebol.info/t/obdc-excel-and-memory-allocation-problems/280.rss">OBDC, Excel and memory allocation problems</source>
      </item>
      <item>
        <title>OBDC, Excel and memory allocation problems</title>
        <dc:creator><![CDATA[orr721]]></dc:creator>
        <description><![CDATA[
            <p>I did some more digging..</p>
<ol>
<li>The memory allocation problem is not Ren-C specific at all. There are several reports from people having the same problem:</li>
</ol>
<ul>
<li>in PHP: <a href="https://bugs.php.net/bug.php?id=68964" rel="nofollow noopener">https://bugs.php.net/bug.php?id=68964</a>,</li>
<li>in MySQL: <a href="https://forums.mysql.com/read.php?10,618038,618760" rel="nofollow noopener">https://forums.mysql.com/read.php?10,618038,618760</a>,</li>
<li>in a ODBC bridge: <a href="http://www.easysoft.com/support/kb/kb00712.html" rel="nofollow noopener">http://www.easysoft.com/support/kb/kb00712.html</a>).</li>
</ul>
<ol start="2">
<li>
<p>According to Microsoft ODBC <a href="https://github.com/Microsoft/ODBC-Specification/blob/0583d997331a898bb0077e3cb58e210ced3a5ff1/Windows/inc/sqlext.h" rel="nofollow noopener">sqlext.h</a> header file, the <code>SQL_DATA_TYPE -1</code> corresponds to <code>SQL_LONGVARCHAR</code>. This data-type has no fixed length limit, hence the ODBC reported <code>BUFFER_LENGTH</code> and <code>COLUMN_SIZE</code> of <code>1073741824</code> (which equals 1 GB).</p>
</li>
<li>
<p>So i think the problematic code is the line number <code>834</code> of the <code>ODBC_BindColumns</code> function in the <code>ren-c/src/extensions/odbc/mod-odbc.c</code> file, where the buffer size is determined:</p>
<p>case SQL_CHAR:<br>
case SQL_VARCHAR:<br>
case SQL_LONGVARCHAR: // <a href="https://stackoverflow.com/a/9547441" rel="nofollow noopener">https://stackoverflow.com/a/9547441</a></p>
<p>--snip--</p>
<pre><code> c-&gt;c_type = SQL_C_WCHAR;
</code></pre>
<p>--snip--</p>
<p>c-&gt;buffer_size = sizeof(WCHAR) * (c-&gt;column_size + 1);<br>
break;</p>
</li>
<li>
<p>The Microsoft recommended way how to handle this data-type is to use maximum allowed string size or a maximum known size of the source data. I have checked for Excel where the maximum cell size is 32K. It could be different (larger) for other ODBC databases. Actually that <a href="https://stackoverflow.com/a/9547441" rel="nofollow noopener">https://stackoverflow.com/a/9547441</a> reference talks about the 32K limit but as far as I can tell it is not enforced anywhere in the <code>mod-odbc.c</code> code.</p>
</li>
</ol>
<p>So could some one able to compile Ren-C please devise a way how to cap the <code>column_size</code> to 32K and test it..</p>
          <p><a href="https://forum.rebol.info/t/obdc-excel-and-memory-allocation-problems/280/14">Read full topic</a></p>
        ]]></description>
        <link>https://forum.rebol.info/t/obdc-excel-and-memory-allocation-problems/280/14</link>
        <pubDate>Sun, 03 Sep 2017 02:06:27 +0000</pubDate>
        <guid isPermaLink="false">forum.rebol.info-post-280-14</guid>
        <source url="https://forum.rebol.info/t/obdc-excel-and-memory-allocation-problems/280.rss">OBDC, Excel and memory allocation problems</source>
      </item>
      <item>
        <title>OBDC, Excel and memory allocation problems</title>
        <dc:creator><![CDATA[gchiu]]></dc:creator>
        <description><![CDATA[
            <p>I'd report the code you used, the data so it can be reproduced etc on github as a bug in the meantime.</p>
          <p><a href="https://forum.rebol.info/t/obdc-excel-and-memory-allocation-problems/280/13">Read full topic</a></p>
        ]]></description>
        <link>https://forum.rebol.info/t/obdc-excel-and-memory-allocation-problems/280/13</link>
        <pubDate>Fri, 01 Sep 2017 23:28:26 +0000</pubDate>
        <guid isPermaLink="false">forum.rebol.info-post-280-13</guid>
        <source url="https://forum.rebol.info/t/obdc-excel-and-memory-allocation-problems/280.rss">OBDC, Excel and memory allocation problems</source>
      </item>
      <item>
        <title>OBDC, Excel and memory allocation problems</title>
        <dc:creator><![CDATA[orr721]]></dc:creator>
        <description><![CDATA[
            <p>I got it running in Python:</p>
<pre><code>C:\TEMP\py&gt;python
Python 3.5.0 (v3.5.0:374f501f4567, Sep 13 2015, 02:16:59) [MSC v.1900 32 bit (Intel)] on win32
Type "help", "copyright", "credits" or "license" for more information.
&gt;&gt;&gt; import pyodbc
&gt;&gt;&gt; cnxn = pyodbc.connect(r'DRIVER={Microsoft Excel Driver (*.xls, *.xlsx, *.xlsm, *.xlsb)};DBQ=C:\exp.xlsx;', autocommit=True)
&gt;&gt;&gt; cur = cnxn.cursor()
&gt;&gt;&gt; cur.execute("select * from [Sheet0$]")
&lt;pyodbc.Cursor object at 0x03173E20&gt;
&gt;&gt;&gt; rows = cur.fetchall()
&gt;&gt;&gt; for r in rows:
...     print(len(r[6]), ' ', end='')
...
733  887  656  510  663  828  763  1006  982  678  927  908  1245  1074  806  661  1207  744  1139  839  537  446  756  624  879  809  763  570  1165  733  1064  821  588  1033  584  691  673  730  1446  572  907  645  819  801  1384  487  1179  1109  575  950  888  1012  673  650  844  678  1574  1077  495  996  1015  630  1359  822  679  673  969  578  1054  658  1073  504
</code></pre>
<p>The ODBC library is called <strong>pyodbc</strong> and the source is at: <a href="https://github.com/mkleehammer/pyodbc" rel="nofollow noopener">https://github.com/mkleehammer/pyodbc</a></p>
<p>Thanks again for your consideration..</p>
          <p><a href="https://forum.rebol.info/t/obdc-excel-and-memory-allocation-problems/280/12">Read full topic</a></p>
        ]]></description>
        <link>https://forum.rebol.info/t/obdc-excel-and-memory-allocation-problems/280/12</link>
        <pubDate>Fri, 01 Sep 2017 16:36:39 +0000</pubDate>
        <guid isPermaLink="false">forum.rebol.info-post-280-12</guid>
        <source url="https://forum.rebol.info/t/obdc-excel-and-memory-allocation-problems/280.rss">OBDC, Excel and memory allocation problems</source>
      </item>
      <item>
        <title>OBDC, Excel and memory allocation problems</title>
        <dc:creator><![CDATA[orr721]]></dc:creator>
        <description><![CDATA[
            <p>These are the column properties ODBC is reporting for the big columns (see my second post):</p>
<pre><code>TABLE_CAT C:\exp.xlsx
TABLE_SCHEM
TABLE_NAME Sheet0$
COLUMN_NAME Nález
DATA_TYPE -1
TYPE_NAME
COLUMN_SIZE 1073741824
BUFFER_LENGTH 1073741824
DECIMAL_DIGITS
NUM_PREC_RADIX
NULLABLE 1
REMARKS
COLUMN_DEF
SQL_DATA_TYPE -1
SQL_DATETIME_SUB
CHAR_OCTET_LENGTH 1073741824
ORDINAL_POSITION 7
IS_NULLABLE YES
ORDINAL 7
</code></pre>
<p>Please notice TYPE_NAME (empty), COLUMN_SIZE, BUFFER_LENGTH, CHAR_OCTET_LENGTH (1073741824).</p>
<p>So ODBC wants Ren-C to allocate 1 GB of memory and this fails. However Rebol2/View can somehow deduce that this is some kind of a special type (by the SQL_DATA_TYPE property?) and allocates just enough for it to make it work.</p>
<p>Could it be that the datatype -1 means BLOB datatype? I have tried to search through Microsoft ODBC documentation but I have found nothing. They refer to types only by their names not by the constant values.</p>
<p>This is taken from Rebol2/View, so you believe me, (the big columns are number 7 and 8)..</p>
<pre><code>&gt;&gt; insert conn-port "select * from [Sheet0$]"
&gt;&gt; rec: copy conn-port
== [[ ... ]]
&gt;&gt; reclen: copy [] foreach i rec [append reclen length? i/7] print unique sort reclen
446 478 487 495 504 510 537 570 572 575 578 584 588 624 630 645 650 651 656 658 661 663 673 678 679 691 728 730 733 744 756 76
3 801 806 809 819 821 822 828 839 844 879 887 888 907 908 927 950 969 982 996 1006 1012 1015 1033 1054 1064 1073 1074 1077 110
9 1139 1165 1179 1207 1245 1359 1384 1446 1574
&gt;&gt;
</code></pre>
<p>I will try to search for some other ODBC implementation where it works and will report. Any tips what would be the easiest to understand and to port later on? Ruby? Scheme?</p>
<p>Thanks.</p>
          <p><a href="https://forum.rebol.info/t/obdc-excel-and-memory-allocation-problems/280/11">Read full topic</a></p>
        ]]></description>
        <link>https://forum.rebol.info/t/obdc-excel-and-memory-allocation-problems/280/11</link>
        <pubDate>Fri, 01 Sep 2017 07:25:03 +0000</pubDate>
        <guid isPermaLink="false">forum.rebol.info-post-280-11</guid>
        <source url="https://forum.rebol.info/t/obdc-excel-and-memory-allocation-problems/280.rss">OBDC, Excel and memory allocation problems</source>
      </item>
      <item>
        <title>OBDC, Excel and memory allocation problems</title>
        <dc:creator><![CDATA[hostilefork]]></dc:creator>
        <description><![CDATA[
            <aside class="quote no-group" data-post="7" data-topic="280">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="//forum.rebol.info/user_avatar/forum.rebol.info/orr721/40/235_2.png" class="avatar"> orr721:</div>
<blockquote>
<p>This specific ODBC driver supports VARCHAR only for length 255 and no other types for larger strings are available (i.e. no LONGVARCHAR, BLOB, etc.).</p>
</blockquote>
</aside>
<aside class="quote no-group" data-post="7" data-topic="280">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="//forum.rebol.info/user_avatar/forum.rebol.info/orr721/40/235_2.png" class="avatar"> orr721:</div>
<blockquote>
<p>While the ODBC driver itself can work with the big columns without any problems (even though the datatype itself is "unsupported") I have not found a way how to tell the Ren-C ODBC module to accept it.</p>
</blockquote>
</aside>
<p>I'm not that surprised if SQL statements issued to some random "database" willingly works with an overlong VARCHAR(255), because you're just throwing instructions over to the database; it does all the work on its side, and there's not any issue with whether ODBC understands what it's asking.</p>
<p>What I might find surprising would be if the type indicator is formally marked VARCHAR(255) in its specification, yet using some clients it returns longer than 255 and this is tolerated...and for instance Rebol2 is such a client?  Are you sure?  <img src="//forum.rebol.info/images/emoji/twitter/frowning.png?v=7" title=":frowning:" class="emoji" alt=":frowning:"></p>
<p>It might be possible, though sketchy.  The way ODBC works, is that you provide memory buffers of sufficient size for each column, in a process called binding.  It is the case that for some types, if you provide too small a buffer, you can get back a status code indicating this... SQL_SUCCESS_WITH_INFO with SQLSTATE 01004 (Data truncated)</p>
<p><a href="https://docs.microsoft.com/en-us/sql/odbc/reference/develop-app/data-length-buffer-length-and-truncation" class="onebox" target="_blank" rel="nofollow noopener">https://docs.microsoft.com/en-us/sql/odbc/reference/develop-app/data-length-buffer-length-and-truncation</a></p>
<p>It says:</p>
<blockquote>
<p>When data truncation occurs, the application can sometimes allocate a larger buffer and refetch the data; <strong>this is not true in all cases.</strong> (emphasis mine)</p>
</blockquote>
<p>The routine that would be returning SQLSTATE 01004 would be, I guess, SQLFetch...here:</p>
<aside class="onebox githubblob">
  <header class="source">
      <a href="https://github.com/metaeducation/ren-c/blob/804618c1a0b5bc1554c9622b21da5a7011721e78/src/extensions/odbc/mod-odbc.c#L1296" target="_blank" rel="nofollow noopener">github.com</a>
  </header>
  <article class="onebox-body">
    <h4><a href="https://github.com/metaeducation/ren-c/blob/804618c1a0b5bc1554c9622b21da5a7011721e78/src/extensions/odbc/mod-odbc.c#L1296" target="_blank" rel="nofollow noopener">metaeducation/ren-c/blob/804618c1a0b5bc1554c9622b21da5a7011721e78/src/extensions/odbc/mod-odbc.c#L1296</a></h4>
<pre class="onebox"><code class="lang-c"><ol class="start lines" start="1286" style="counter-reset: li-counter 1285 ;">
<li>else {</li>
<li>    assert(IS_INTEGER(ARG(length)));</li>
<li>    num_rows = VAL_INT32(ARG(length));</li>
<li>}</li>
<li>
</li>
<li>REBDSP dsp_orig = DSP;</li>
<li>
</li>
<li>// Fetch columns</li>
<li>//</li>
<li>SQLULEN row = 0;</li>
<li class="selected">while ((row != num_rows) &amp;&amp; (SQLFetch(hstmt) != SQL_NO_DATA)) {</li>
<li>    REBARR *record = Make_Array(num_columns);</li>
<li>
</li>
<li>    SQLSMALLINT col;</li>
<li>    for (col = 0; col &lt; num_columns; ++col)</li>
<li>        ODBC_Column_To_Rebol_Value(ARR_AT(record, col), &amp;columns[col]);</li>
<li>    TERM_ARRAY_LEN(record, num_columns);</li>
<li>
</li>
<li>    DS_PUSH_TRASH;</li>
<li>    Init_Block(DS_TOP, record);</li>
<li>    ++row;</li>
</ol></code></pre>


  </article>
  <div class="onebox-metadata">
    
    
  </div>
  <div style="clear: both"></div>
</aside>

<p>So the deal would be that it's possible to notice you've been lied to about the length and a field wound up truncated, update the binding, and then fetch again perhaps.  Of course you're operating in an inconsistent world, where the length limit is a lie, and I'd certainly think it's something any given ODBC client or driver would consider undefined behavior.</p>
<p>If you've got proof it's being done then it has been done, though it would help if that proof came along with source code to see how they were doing it.  Hence if you can point to an open source application which has the feature, that would be more useful.</p>
<p>All this said, I don't know how much work we can promise.  We'd like to have more participants here, but we don't really have a huge developer "budget" for things beyond our core focus unless people are willing to contribute in kind.</p>
          <p><a href="https://forum.rebol.info/t/obdc-excel-and-memory-allocation-problems/280/10">Read full topic</a></p>
        ]]></description>
        <link>https://forum.rebol.info/t/obdc-excel-and-memory-allocation-problems/280/10</link>
        <pubDate>Fri, 01 Sep 2017 02:54:27 +0000</pubDate>
        <guid isPermaLink="false">forum.rebol.info-post-280-10</guid>
        <source url="https://forum.rebol.info/t/obdc-excel-and-memory-allocation-problems/280.rss">OBDC, Excel and memory allocation problems</source>
      </item>
      <item>
        <title>OBDC, Excel and memory allocation problems</title>
        <dc:creator><![CDATA[orr721]]></dc:creator>
        <description><![CDATA[
            <p>Yeah, I have tried. But even after reinstalling MS Office, installing the dependencies, it doesn't work for me (I have tried yesterday). But I have to admit I do have a strange combination of Office 2003 and Office 2010 Starter on my Windows computer so I am not complaining.</p>
<p>ODBC seemed to me like a more universal, cleaner and faster way. Hey, and it mostly works! <img src="//forum.rebol.info/images/emoji/twitter/slight_smile.png?v=7" title=":slight_smile:" class="emoji" alt=":slight_smile:"></p>
          <p><a href="https://forum.rebol.info/t/obdc-excel-and-memory-allocation-problems/280/9">Read full topic</a></p>
        ]]></description>
        <link>https://forum.rebol.info/t/obdc-excel-and-memory-allocation-problems/280/9</link>
        <pubDate>Thu, 31 Aug 2017 23:52:52 +0000</pubDate>
        <guid isPermaLink="false">forum.rebol.info-post-280-9</guid>
        <source url="https://forum.rebol.info/t/obdc-excel-and-memory-allocation-problems/280.rss">OBDC, Excel and memory allocation problems</source>
      </item>
      <item>
        <title>OBDC, Excel and memory allocation problems</title>
        <dc:creator><![CDATA[gchiu]]></dc:creator>
        <description><![CDATA[
            <p>If you're trying to do "SQL" on an Excel file, then I'd suggest you consider using Ashley's <a href="http://www.dobeash.com/munge.html" rel="nofollow noopener">munge</a> script which he has made compatible with r3/Ren-c.</p>
          <p><a href="https://forum.rebol.info/t/obdc-excel-and-memory-allocation-problems/280/8">Read full topic</a></p>
        ]]></description>
        <link>https://forum.rebol.info/t/obdc-excel-and-memory-allocation-problems/280/8</link>
        <pubDate>Thu, 31 Aug 2017 23:44:38 +0000</pubDate>
        <guid isPermaLink="false">forum.rebol.info-post-280-8</guid>
        <source url="https://forum.rebol.info/t/obdc-excel-and-memory-allocation-problems/280.rss">OBDC, Excel and memory allocation problems</source>
      </item>
      <item>
        <title>OBDC, Excel and memory allocation problems</title>
        <dc:creator><![CDATA[orr721]]></dc:creator>
        <description><![CDATA[
            <p>Well, unfortunately I was a bit too quick in making my conclusions. It works, but after the typecast the big columns are truncated to 255 chars.</p>
<p>This specific ODBC driver supports VARCHAR only for length 255 and no other types for larger strings are available (i.e. no LONGVARCHAR, BLOB, etc.).</p>
<pre><code>&gt;&gt; insert conn-port ['types]
== [TYPE_NAME DATA_TYPE COLUMN_SIZE LITERAL_PREFIX LITERAL_SUFFIX CREATE_PARAMS NULLABLE CASE_SENSITIVE SEARCHABLE UNSIGNED_ATTRIBUTE FIXED_PREC_SCALE AUTO_UNIQUE_VALUE LOCAL_TYPE_NAME MINIMUM_SCALE MAXIMUM_SCALE SQL_DATA_TYPE SQL_DATETIME_SUB NUM_PREC_RADIX INTERVAL_PRECISION]                                                                                                          
                                                                                                                                
&gt;&gt; copy conn-port
== [["LOGICAL" -7 1 _ _ _ 0 0 2 _ 0 _ _ 0 0 -7 _ _ _] ["CURRENCY" 2 19 _ _ _ 1 0 2 0 1 0 _ 4 4 2 _ 10 _] ["NUMBER" 8 53 _ _ _ 1 0 2 0 0 0 _ _ _ 8 _ 2 _] ["VARCHAR" 12 255 "'" "'" _ 1 1 3 _ 0 _ _ _ _ 12 _ _ _] ["DATETIME" 93 19 "#" "#" _ 1 0 2 _ 0 _ _ 0 0 9 3 _ _]]  
</code></pre>
<p>While the ODBC driver itself can work with the big columns without any problems (even though the datatype itself is "unsupported") I have not found a way how to tell the Ren-C ODBC module to accept it. Unfortunately I am not much of a C programmer and really can't fix any C code.</p>
<p>I have tested various SQL string operations and all work with the full column data, i.e. beyond the 255 char limit. So a potential work-around would be to split the big columns in SQL to several 255 char parts and then join them back in Ren-C. Or go back to Rebol2/View where it strangely enough doesn't have this problem.</p>
<p>Regarding myself, I use Rebol mostly for scripting short "glue" code to collect data from various sources, modify it and export it for further use in databases, making statistics, etc. I like it very much because it is small, multiplatform (I have used it on Solaris, NetBSD, MS Windows, Linux, MacOSX, even classic MacOS, ...), it is dynamic, easy to use, etc.. A real swiss army knife for any quick work. I have to admit I still fight with the parse rules for string processing so sometimes I use awk (which is an excellent small tool as well).</p>
<p>Thanks again!</p>
          <p><a href="https://forum.rebol.info/t/obdc-excel-and-memory-allocation-problems/280/7">Read full topic</a></p>
        ]]></description>
        <link>https://forum.rebol.info/t/obdc-excel-and-memory-allocation-problems/280/7</link>
        <pubDate>Thu, 31 Aug 2017 23:25:51 +0000</pubDate>
        <guid isPermaLink="false">forum.rebol.info-post-280-7</guid>
        <source url="https://forum.rebol.info/t/obdc-excel-and-memory-allocation-problems/280.rss">OBDC, Excel and memory allocation problems</source>
      </item>
      <item>
        <title>OBDC, Excel and memory allocation problems</title>
        <dc:creator><![CDATA[gchiu]]></dc:creator>
        <description><![CDATA[
            <aside class="quote no-group quote-modified" data-post="23" data-topic="114">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="//forum.rebol.info/user_avatar/forum.rebol.info/orr721/40/235_2.png" class="avatar"><a href="//forum.rebol.info/t/testing-odbc-branch/114/23">Testing ODBC branch</a>
</div>
<blockquote>
<p>So thanks for the pointers. The question remains though, shouldn't it work automatically like in Rebol2/View?</p>
</blockquote>
</aside>
<p>Rebol2 was a mature product of many decades of work.  We don't have the source code but it would seem some of its magic was not safe!</p>
<p>The error message suggested that the ODBC driver was not allocating enough memory for an unexpected result hence my suggestion that you cast the result first so that the driver would know to allocate the right amount of memory.</p>
          <p><a href="https://forum.rebol.info/t/obdc-excel-and-memory-allocation-problems/280/6">Read full topic</a></p>
        ]]></description>
        <link>https://forum.rebol.info/t/obdc-excel-and-memory-allocation-problems/280/6</link>
        <pubDate>Thu, 31 Aug 2017 23:12:22 +0000</pubDate>
        <guid isPermaLink="false">forum.rebol.info-post-280-6</guid>
        <source url="https://forum.rebol.info/t/obdc-excel-and-memory-allocation-problems/280.rss">OBDC, Excel and memory allocation problems</source>
      </item>
      <item>
        <title>OBDC, Excel and memory allocation problems</title>
        <dc:creator><![CDATA[hostilefork]]></dc:creator>
        <description><![CDATA[
            <aside class="quote no-group quote-modified" data-post="20" data-topic="114">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="//forum.rebol.info/user_avatar/forum.rebol.info/orr721/40/235_2.png" class="avatar"><a href="//forum.rebol.info/t/testing-odbc-branch/114/20">Testing ODBC branch</a>
</div>
<blockquote>
<p>Hi there! First time posting on a Rebol/Ren-C/Red forum, I hope this is the right place for my question.</p>
</blockquote>
</aside>
<p>Welcome!  Yes, this is a good place to ask questions regarding Rebol.  I was once a skeptic of the idea of making a forum <em>(I preferred <a href="https://chat.stackoverflow.com/rooms/291/rebol" rel="nofollow noopener">our chat</a>, GitHub Issues, <a href="https://trello.com/b/l385BE7a/rebol3-porting-guide-ren-c-branch" rel="nofollow noopener">Trello</a>, <a href="https://stackoverflow.com/questions/tagged/rebol" rel="nofollow noopener">StackOverflow Q&amp;A</a>...)</em> and wondered if it would just be a burden to have another "place".  But I think it turned out to be a good medium for longer-attention-span discussions that don't fit elsewhere.</p>
<p><em>(Note that for Red, they do most of their support on Gitter... <a href="https://gitter.im/red/home" rel="nofollow noopener">here is their list of rooms</a>)</em></p>
<aside class="quote no-group quote-modified" data-post="23" data-topic="114">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="//forum.rebol.info/user_avatar/forum.rebol.info/orr721/40/235_2.png" class="avatar"><a href="//forum.rebol.info/t/testing-odbc-branch/114/23">Testing ODBC branch</a>
</div>
<blockquote>
<p>The question remains though, shouldn't it work automatically like in Rebol2/View?</p>
</blockquote>
</aside>
<p>The ODBC support was an attempt by me to get the ball rolling by hacking on an <a href="https://github.com/gurzgri/r3-odbc" rel="nofollow noopener">R3-Alpha extension written by Christian Ensel</a> so that it could work in a minimal sense.  I don't know how true that extension was to Rebol2, as I have no real experience with historical ODBC in Rebol <em>(I did not arrive on the scene until the R3 times)</em>.</p>
<p>So over the span of a week or so I managed to get something going, against MySQL's ODBC driver on Windows.  I concocted a single test file to see what it could do:</p>
<aside class="onebox githubblob">
  <header class="source">
      <a href="https://github.com/metaeducation/ren-c/blob/master/tests/misc/odbc-test.reb" target="_blank" rel="nofollow noopener">github.com</a>
  </header>
  <article class="onebox-body">
    <h4><a href="https://github.com/metaeducation/ren-c/blob/master/tests/misc/odbc-test.reb" target="_blank" rel="nofollow noopener">metaeducation/ren-c/blob/master/tests/misc/odbc-test.reb</a></h4>
<pre><code class="lang-reb">Rebol [
    Title: "ODBC Test Script"
    Description: {
        This script does some basic table creation, assuming you have
        configured an ODBC connection with the DSN "Rebol" that has a "test"
        database inside it.  Then it queries to make sure it can get the
        data back out.
    }
]

tables: [
    bit "BIT" [#[false] #[true]]

    tinyint_s "TINYINT" [-128 -10 0 10 127]
    tinyint_u "TINYINT UNSIGNED" [0 10 20 30 255]
    smallint_s "SMALLINT" [-32768 -10 0 10 32767]
    smallint_u "SMALLINT UNSIGNED" [0 10 20 30 65535]
    integer_s "INT" [-2147483648 -10 0 10 2147483647]
    integer_u "INT UNSIGNED" [0 10 20 30 4294967295]
    bigint_s "BIGINT" [-9223372036854775808 -10 0 10 9223372036854775807]
</code></pre>

  This file has been truncated. <a href="https://github.com/metaeducation/ren-c/blob/master/tests/misc/odbc-test.reb" target="_blank" rel="nofollow noopener">show original</a>

  </article>
  <div class="onebox-metadata">
    
    
  </div>
  <div style="clear: both"></div>
</aside>

<p>That's about as far as we've gotten, though it's better than nothing!!</p>
<p>So I don't presume to know what it should or should not do.  It's mostly on those in the community who have a stake to come in and say what it would take for them to feel engaged and want to be involved.  I've got a lot of questions about the PORT! design in the first place, and I also feel like there's a lot more STRING! use than I'd like to see for a dialect.  One of Rebol's strengths is supposed to be DSLs, so it would seem a smoother and more integrated SQL using WORD!s and such would be an objective...</p>
<p>We could definitely use some more developers to hack on it with us.  C programmers would be great <img src="//forum.rebol.info/images/emoji/twitter/slight_smile.png?v=7" title=":slight_smile:" class="emoji" alt=":slight_smile:"> but even writing tests and defining what it <em>should</em> do helps.</p>
<p>In any case, please feel free to introduce yourself and your stake in the project here!</p>
<aside class="quote" data-post="1" data-topic="197">
  <div class="title">
    <div class="quote-controls"></div>
    <img alt="" width="20" height="20" src="/user_avatar/forum.rebol.info/gchiu/40/22_2.png" class="avatar">
    <a href="https://forum.rebol.info/t/introductions-who-am-i/197">Introductions - who am I?</a> <a class="badge-wrapper  bullet" href="/c/community"><span class="badge-category-bg" style="background-color: #12A89D;"></span><span style="" data-drop-close="true" class="badge-category clear-badge" title="Topics of the Rebol community, including announcements, founding/deprecation of Rebol related websites or local communities, applications, new publications or other resources, advertisements, etc.">Community</span></a>
  </div>
  <blockquote>
    If you're using a pseudonym here, then we'd appreciate it if you would post a little about your experience with Rebol.  And of course, if you're a long time Rebol user back from whenever, and have been on the mailing list etc, then feel free to mention this. 
Thanks. 
PS: Please add any Github or other Repos, and LinkedIn if you wish.
  </blockquote>
</aside>

          <p><a href="https://forum.rebol.info/t/obdc-excel-and-memory-allocation-problems/280/3">Read full topic</a></p>
        ]]></description>
        <link>https://forum.rebol.info/t/obdc-excel-and-memory-allocation-problems/280/3</link>
        <pubDate>Thu, 31 Aug 2017 22:01:05 +0000</pubDate>
        <guid isPermaLink="false">forum.rebol.info-post-280-3</guid>
        <source url="https://forum.rebol.info/t/obdc-excel-and-memory-allocation-problems/280.rss">OBDC, Excel and memory allocation problems</source>
      </item>
      <item>
        <title>OBDC, Excel and memory allocation problems</title>
        <dc:creator><![CDATA[orr721]]></dc:creator>
        <description><![CDATA[
            <p>Whoa, after some googling I have found that this works:</p>
<pre><code>insert conn-port "select Meno, {fn convert(Nález, SQL_VARCHAR)} as nalez, {fn convert(Záver, SQL_VARCHAR)} as zaver from [Sheet0$]"
== [Meno nalez zaver]
</code></pre>
<p>So thanks for the pointers. The question remains though, shouldn't it work automatically like in Rebol2/View?</p>
          <p><a href="https://forum.rebol.info/t/obdc-excel-and-memory-allocation-problems/280/5">Read full topic</a></p>
        ]]></description>
        <link>https://forum.rebol.info/t/obdc-excel-and-memory-allocation-problems/280/5</link>
        <pubDate>Thu, 31 Aug 2017 15:00:54 +0000</pubDate>
        <guid isPermaLink="false">forum.rebol.info-post-280-5</guid>
        <source url="https://forum.rebol.info/t/obdc-excel-and-memory-allocation-problems/280.rss">OBDC, Excel and memory allocation problems</source>
      </item>
      <item>
        <title>OBDC, Excel and memory allocation problems</title>
        <dc:creator><![CDATA[orr721]]></dc:creator>
        <description><![CDATA[
            <blockquote>
<p>Can you try casting the result eg varchar(1500) ?</p>
</blockquote>
<p>I am sorry, you have to help me a bit here, because I don't know how to do that.</p>
<p>Anyway I have checked the column properties and there is something strange with the 2 mentioned columns:</p>
<pre><code>&gt;&gt; insert conn-port ['columns "Sheet0$"]
== [TABLE_CAT TABLE_SCHEM TABLE_NAME COLUMN_NAME DATA_TYPE TYPE_NAME COLUMN_SIZE BUFFER_LENGTH DECIMAL_DIGITS NUM_PREC_RADIX NULLABLE REMARKS COLUMN_DEF SQL_DATA_TYPE SQL_DATETIME_SUB CHAR_OCTET_LENGTH ORDINAL_POSITION IS_NULLABLE ORDINAL]

&gt;&gt; copy conn-port
== [["C:\exp.xlsx" _ "Sheet0$" "Priezvisko" -9 "VARCHAR" 255 510 _ _ 1 _ _ -9 _ 510 1 "YES" 1]
["C:\exp.xlsx" _ "Sheet0$" "Meno" -9 "VARCHAR" 255 510 _ _ 1 _ _ -9 _ 510 2 "YES" 2]

--snip--

["C:\exp.xlsx" _ "Sheet0$" "Nález" -1 _ 1073741824 1073741824 _ _ 1 _ _ -1 _ 1073741824 7 "YES" 7]
["C:\exp.xlsx" _ "Sheet0$" "Záver" -1 _ 1073741824 1073741824 _ _ 1 _ _ -1 _ 1073741824 8 "YES" 8]

 --snip--
        ]
</code></pre>
<p>The problematic columns are "Nález" and "Záver".</p>
<p>Thank you very much.</p>
          <p><a href="https://forum.rebol.info/t/obdc-excel-and-memory-allocation-problems/280/4">Read full topic</a></p>
        ]]></description>
        <link>https://forum.rebol.info/t/obdc-excel-and-memory-allocation-problems/280/4</link>
        <pubDate>Thu, 31 Aug 2017 11:01:30 +0000</pubDate>
        <guid isPermaLink="false">forum.rebol.info-post-280-4</guid>
        <source url="https://forum.rebol.info/t/obdc-excel-and-memory-allocation-problems/280.rss">OBDC, Excel and memory allocation problems</source>
      </item>
      <item>
        <title>OBDC, Excel and memory allocation problems</title>
        <dc:creator><![CDATA[gchiu]]></dc:creator>
        <description><![CDATA[
            <p>Can you try casting the result eg varchar(1500) ?</p>
          <p><a href="https://forum.rebol.info/t/obdc-excel-and-memory-allocation-problems/280/2">Read full topic</a></p>
        ]]></description>
        <link>https://forum.rebol.info/t/obdc-excel-and-memory-allocation-problems/280/2</link>
        <pubDate>Thu, 31 Aug 2017 10:21:16 +0000</pubDate>
        <guid isPermaLink="false">forum.rebol.info-post-280-2</guid>
        <source url="https://forum.rebol.info/t/obdc-excel-and-memory-allocation-problems/280.rss">OBDC, Excel and memory allocation problems</source>
      </item>
      <item>
        <title>OBDC, Excel and memory allocation problems</title>
        <dc:creator><![CDATA[orr721]]></dc:creator>
        <description><![CDATA[
            <p><strong>Error: Couldn't allocate column buffer</strong></p>
<p>Hi there! First time posting on a Rebol/Ren-C/Red forum, I hope this is the right place for my question. I have been testing the ODBC functionality in <em>Ren-C build 2.102.0.3.1</em> from <strong>10-Aug-2017/5:25:53</strong> on Windows 10 Pro.</p>
<p>Is there any way how to increase the available memory for the ODBC query? Because I have some kind of memory allocation problem while running my queries..</p>
<pre><code>&gt;&gt; insert conn-port "select * from [Sheet0$] where Meno = 'ALENA'"
** Error: Couldn't allocate column buffer!
** Where: insert-odbc --anonymous-- insert
** Near: reduce compose [(sql)] ??
</code></pre>
<p>The query should return 1 record from an XLSX file with 13 columns, where 2 of the columns contain strings longer than 1500 characters. When I run the select query without these two columns the query runs fine and I receive my data.</p>
<p>I am a bit confused with this problem because in Rebol2/View I can run the same query with all 100 records (without the <code>where</code> clause) in a single statement without any memory problems. Am I missing something or is it a bug in the ODBC Ren-C implementation? Thank you very much for an answer and for your excellent work.</p>
<p>P.S. running TRACE ON crashes the executable immediately..</p>
          <p><a href="https://forum.rebol.info/t/obdc-excel-and-memory-allocation-problems/280/1">Read full topic</a></p>
        ]]></description>
        <link>https://forum.rebol.info/t/obdc-excel-and-memory-allocation-problems/280/1</link>
        <pubDate>Thu, 31 Aug 2017 09:29:41 +0000</pubDate>
        <guid isPermaLink="false">forum.rebol.info-post-280-1</guid>
        <source url="https://forum.rebol.info/t/obdc-excel-and-memory-allocation-problems/280.rss">OBDC, Excel and memory allocation problems</source>
      </item>
  </channel>
</rss>
