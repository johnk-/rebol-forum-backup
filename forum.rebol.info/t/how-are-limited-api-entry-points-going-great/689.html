<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>How are limited API entry points going? Great! - Language Bridging - AltRebol</title>
    <meta name="description" content="When I first was going about trying to wrangle the ODBC extension to work in Ren-C, it had some C time and date structures that would come back from the database.  These are DATE_STRUCT, TIME_STRUCT, and TIMESTAMP_STRUCT&amp;hellip;">
    <meta name="generator" content="Discourse 2.7.0.beta4 - https://github.com/discourse/discourse version 3fc72543de22c329cf2156f28b781821adc496ae">
<link rel="icon" type="image/png" href="../../uploads/default/optimized/1X/cbd70027b53fa165575e5b665f00eb3b8ae7ea31_2_32x32.ico">
<link rel="apple-touch-icon" type="image/png" href="../../uploads/default/optimized/1X/ae4ccad1a2789bb1e85cf5a0f52f2f1de10da26d_2_180x180.png">
<meta name="theme-color" content="#ffffff">
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, user-scalable=yes, viewport-fit=cover">
<link rel="canonical" href="689.html" />
<script type="application/ld+json">{"@context":"http://schema.org","@type":"WebSite","url":"https://forum.rebol.info","potentialAction":{"@type":"SearchAction","target":"https://forum.rebol.info/search?q={search_term_string}","query-input":"required name=search_term_string"}}</script>
<link rel="search" type="application/opensearchdescription+xml" href="../../opensearch.xml" title="AltRebol Search">

      <link href="https://forum.rebol.info/stylesheets/desktop_e71c7b3a0694e7f6434c54a663bfb42821f8bd81.css?__ws=forum.rebol.info" media="all" rel="stylesheet" data-target="desktop" />
    
    
        <link rel="alternate" type="application/rss+xml" title="RSS feed of &#39;How are limited API entry points going? Great!&#39;" href="689.rss" />
    <meta property="og:site_name" content="AltRebol" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:image" content="https://forum.rebol.info/uploads/default/original/1X/ae4ccad1a2789bb1e85cf5a0f52f2f1de10da26d.png" />
<meta property="og:image" content="https://forum.rebol.info/uploads/default/original/1X/ae4ccad1a2789bb1e85cf5a0f52f2f1de10da26d.png" />
<meta property="og:url" content="https://forum.rebol.info/t/how-are-limited-api-entry-points-going-great/689" />
<meta name="twitter:url" content="https://forum.rebol.info/t/how-are-limited-api-entry-points-going-great/689" />
<meta property="og:title" content="How are limited API entry points going? Great!" />
<meta name="twitter:title" content="How are limited API entry points going? Great!" />
<meta property="og:description" content="When I first was going about trying to wrangle the ODBC extension to work in Ren-C, it had some C time and date structures that would come back from the database.  These are DATE_STRUCT, TIME_STRUCT, and TIMESTAMP_STRUCT.  Those have to be turned into TIME! and DATE! values.  But there were no functions in the API yet for making TIME! and DATE! values.  Well, there was rebInteger() for taking a C integer and making an INTEGER!.  So to move things along, I went ahead and made functions for taking..." />
<meta name="twitter:description" content="When I first was going about trying to wrangle the ODBC extension to work in Ren-C, it had some C time and date structures that would come back from the database.  These are DATE_STRUCT, TIME_STRUCT, and TIMESTAMP_STRUCT.  Those have to be turned into TIME! and DATE! values.  But there were no functions in the API yet for making TIME! and DATE! values.  Well, there was rebInteger() for taking a C integer and making an INTEGER!.  So to move things along, I went ahead and made functions for taking..." />
<meta name="twitter:label1" value="Reading time" />
<meta name="twitter:data1" value="1 mins 🕑" />
<meta name="twitter:label2" value="Likes" />
<meta name="twitter:data2" value="3 ❤" />
<meta property="article:published_time" content="2018-06-15T05:16:44+00:00" />
<meta property="og:ignore_canonical" content="true" />



    
  </head>
  <body class="crawler">
    
    <header>
      <a href="https://forum.rebol.info/">
          <img src="../../uploads/default/original/1X/ae4ccad1a2789bb1e85cf5a0f52f2f1de10da26d.png" alt="AltRebol" id="site-logo" style="max-width: 150px;">
      </a>
    </header>
    <div id="main-outlet" class="wrap">
        <div id="topic-title">
    <h1>
      <a href="689.html">How are limited API entry points going? Great!</a>
    </h1>

      <div class="topic-category" itemscope itemtype="http://schema.org/BreadcrumbList">
          <span itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
            <a href="https://forum.rebol.info/c/development/8" class="badge-wrapper bullet" itemprop="item">
              <span class='badge-category-bg' style='background-color: #25AAE2'></span>
              <span class='badge-category clear-badge'>
                <span class='category-name' itemprop='name'>Development</span>
              </span>
            </a>
            <meta itemprop="position" content="1" />
          </span>
          <span itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
            <a href="https://forum.rebol.info/c/development/language-bridging/35" class="badge-wrapper bullet" itemprop="item">
              <span class='badge-category-bg' style='background-color: #25AAE2'></span>
              <span class='badge-category clear-badge'>
                <span class='category-name' itemprop='name'>Language Bridging</span>
              </span>
            </a>
            <meta itemprop="position" content="2" />
          </span>
      </div>

  </div>

  


      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="http://schema.org/Organization">
            <meta itemprop='name' content='AltRebol'>
              <div itemprop='logo' itemscope itemtype="http://schema.org/ImageObject">
                <meta itemprop='url' content='https://forum.rebol.info/uploads/default/original/1X/ae4ccad1a2789bb1e85cf5a0f52f2f1de10da26d.png'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
            <a itemprop="url" href='https://forum.rebol.info/u/hostilefork'><span itemprop='name'>hostilefork</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="689.html">


          <span class="crawler-post-infos">
              <meta itemprop='datePublished' content='2018-06-15T05:16:44Z'>
              <time itemprop='dateModified' datetime='2019-06-26T14:17:51Z' class='post-time'>
                June 26, 2019,  2:17pm
              </time>
          <span itemprop='position'>#1</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <p>When I first was going about trying to wrangle the ODBC extension to work in Ren-C, it had some C time and date structures that would come back from the database.  These are DATE_STRUCT, TIME_STRUCT, and TIMESTAMP_STRUCT.  Those have to be turned into TIME! and DATE! values.</p>
<p>But there were no functions in the API yet for making TIME! and DATE! values.</p>
<p>Well, there was rebInteger() for taking a C integer and making an INTEGER!.  So to move things along, I went ahead and made functions for taking multiple C integers and making times and dates:</p>
<pre><code>REBVAL *time = rebTimeHMS(hour, minute, second);
REBVAL *date = rebDateYMD(year, month, day);
REBVAL *datetime = rebDateTime(date, time);
</code></pre>
<p>But the API vision has established clarity about being of limited entry points.  So rather than keep cooking up new C functions taking C arguments, it's better to build on a more limited facility and call Rebol code!</p>
<pre><code>REBVAL *time = rebValue("make time! [",
    rebI(hour), rebI(minute), rebI(second),
"]");

REBVAL *date = rebValue("make date! [",
    rebI(day), rebI(month), rebI(year),
"]");

REBVAL *datetime = rebValue("use [date] [",
    "date:", date,
    "date/time:", time,
"]");
</code></pre>
<p>That third one is a little weird, and anyone who wants to suggest a better way of doing it can chime in on <a href="https://github.com/rebol/rebol-issues#2313" rel="nofollow noopener">issue #2313</a>.  But the point is to keep pushing on Rebol the language, not chasing down an infinitely long cascade of API entry points.</p>
<p>I'm feeling really good about it.  Though I will re-iterate that it does bring up all those questions of where this stuff is getting bound.  You don't want some extension deciding to redefine MAKE, or TIME!, and incidentally wind up breaking the ODBC module's expectations.  There has to be some isolation, very much similar to how modules will be isolated...except (somehow) applying to the C code.</p>
<p>But that's the vision, and if you haven't been reading the interesting usages <a href="https://github.com/hostilefork/rebol/blob/d983fdeb89b40329cf3a570f785fc109e951dc83/src/extensions/zeromq/mod-zeromq.c#L386" rel="nofollow noopener">like in the ZeroMQ extension</a>, please do!  Would be good to hear any thoughts people are having, while watching it materialize...</p>
        </div>

        <meta itemprop='headline' content='How are limited API entry points going? Great!'>
          <meta itemprop='keywords' content=''>

        <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="1" />
           <span class='post-likes'>1 Like</span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="0" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="http://schema.org/Organization">
            <meta itemprop='name' content='AltRebol'>
              <div itemprop='logo' itemscope itemtype="http://schema.org/ImageObject">
                <meta itemprop='url' content='https://forum.rebol.info/uploads/default/original/1X/ae4ccad1a2789bb1e85cf5a0f52f2f1de10da26d.png'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
            <a itemprop="url" href='https://forum.rebol.info/u/hostilefork'><span itemprop='name'>hostilefork</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="689.html">


          <span class="crawler-post-infos">
              <meta itemprop='datePublished' content='2018-12-29T08:52:49Z'>
              <time itemprop='dateModified' datetime='2019-06-26T14:25:09Z' class='post-time'>
                June 26, 2019,  2:25pm
              </time>
          <span itemprop='position'>#2</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <p>In the "strings are going great" topic...</p>
<p>I mentioned my concerns about Red's C APIs like <a href="https://doc.red-lang.org/en/libred.html#_redappend" rel="nofollow noopener">redAppend()</a>.  How would you know what refinements to make parameters?  Is there a <code>redAppendPart()</code>, a <code>redAppendPartOnly()</code>, etc?</p>
<p>Ren-C went with a fully generic string-plus-splicing interface.  Every call invokes the evaluator, and so the only difference between the entry points is based on what kind of result you want...so that you can get atomic C values without worrying about separate steps to pick apart API values.</p>
<p>And if you just want to ignore the result entirely, there's rebElide()...so...</p>
<pre><code> rebElide("append/dup", block, value, rebI(num));
</code></pre>
<p>But this raises big questions.  Not only where would these strings be bound, but what would it do to performance to have to bind strings every call?  What about the added cost of path dispatch and word lookup to invoke a function?  An explicit API entry point for <code>rebAppendDup()</code> could be <em>orders of magnitude</em> faster.</p>
<p>I waved my hands a bit and we discussed options which would be a bit like <a href="https://en.wikipedia.org/wiki/Prepared_statement" rel="nofollow noopener">prepared statements</a>.  <strong>But we already have this technology today:</strong></p>
<pre><code> REBVAL *append_dup = rebValue(":append/dup");

 void rebAppendDup(REBVAL *series, REBVAL *value, REBVAL *count)
     { rebElide(append_dup, series, value, count); }
</code></pre>
<p>Boom.  You specialize the function once in startup, and store it in a global somewhere, release it on shutdown.  And now during the call you have no loading or binding, or path dispatch.  It doesn't need to create a BLOCK! or series to hold these variadic parameters, <em>the evaluator feeds them straight from the C va_list</em>!  It's reading the C stack directly.</p>
<p>We could make this even easier with a helper that marked a value as something to auto-free on shutdown.  let's imagine rebPrepare() does that:</p>
<pre><code> void rebAppendDup(REBVAL *series, REBVAL *value, REBVAL *count) {
      static REBVAL *append_dup; // defaults to null pointer
      rebPrepare(&amp;append_dup, ":append/dup"); // only update append_dup if null

      rebElide(append_dup, series, value, count);
 }
</code></pre>
<p><code>rebPrepare()</code> can even be an inline function, so the pointer test of <code>append_dup</code> to null wouldn't need to make an extern "C" function call except the first time.</p>
<p>With a bit of additional cleverness, this could probably just be:</p>
<pre><code> void rebAppendDup(REBVAL *series, REBVAL *value, REBVAL *count) {
      static REBVAL *append_dup;
      rebElide(rebP(&amp;append_dup, ":append/dup"), series, value, count);
 }
</code></pre>
<p>To sum up: Winning!  <img src="../../images/emoji/twitter/zap.png%3Fv=9" title=":zap:" class="emoji" alt=":zap:"></p>
        </div>

        <meta itemprop='headline' content='How are limited API entry points going? Great!'>

        <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="2" />
           <span class='post-likes'>2 Likes</span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="0" />
          </div>

      </div>






    </div>
    <footer class="container wrap">
      <nav class='crawler-nav'>
        <ul>
        <li itemscope itemtype='http://schema.org/SiteNavigationElement'>
          <span itemprop='name'>
            <a href='https://forum.rebol.info/' itemprop="url">Home </a>
          </span>
        </li>
        <li itemscope itemtype='http://schema.org/SiteNavigationElement'>
          <span itemprop='name'>
            <a href='https://forum.rebol.info/categories' itemprop="url">Categories </a>
          </span>
        </li>
        <li itemscope itemtype='http://schema.org/SiteNavigationElement'>
          <span itemprop='name'>
            <a href='https://forum.rebol.info/guidelines' itemprop="url">FAQ/Guidelines </a>
          </span>
        </li>
        <li itemscope itemtype='http://schema.org/SiteNavigationElement'>
          <span itemprop='name'>
            <a href='https://forum.rebol.info/tos' itemprop="url">Terms of Service </a>
          </span>
        </li>
        <li itemscope itemtype='http://schema.org/SiteNavigationElement'>
          <span itemprop='name'>
            <a href='https://forum.rebol.info/privacy' itemprop="url">Privacy Policy </a>
          </span>
        </li>
        </ul>
      </nav>
      <p class='powered-by-link'>Powered by <a href="https://www.discourse.org">Discourse</a>, best viewed with JavaScript enabled</p>
    </footer>
    
    
  </body>
  
</html>
