<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Switching to Stackless: Why this, Why now? - #7 by hostilefork - Internals - AltRebol</title>
    <meta name="description" content="I wanted to write a short explanation about why switching Rebol to a stackless implementation--similar to Stackless Python--has jumped itself up in the priority queue, to something I&amp;#39;m working on in the near term. 
It&amp;#39;s &amp;hellip;">
    <meta name="generator" content="Discourse 2.7.0.beta4 - https://github.com/discourse/discourse version 3fc72543de22c329cf2156f28b781821adc496ae">
<link rel="icon" type="image/png" href="../../../uploads/default/optimized/1X/cbd70027b53fa165575e5b665f00eb3b8ae7ea31_2_32x32.ico">
<link rel="apple-touch-icon" type="image/png" href="../../../uploads/default/optimized/1X/ae4ccad1a2789bb1e85cf5a0f52f2f1de10da26d_2_180x180.png">
<meta name="theme-color" content="#ffffff">
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, user-scalable=yes, viewport-fit=cover">
<link rel="canonical" href="../1247.html" />
<script type="application/ld+json">{"@context":"http://schema.org","@type":"WebSite","url":"https://forum.rebol.info","potentialAction":{"@type":"SearchAction","target":"https://forum.rebol.info/search?q={search_term_string}","query-input":"required name=search_term_string"}}</script>
<link rel="search" type="application/opensearchdescription+xml" href="../../../opensearch.xml" title="AltRebol Search">

      <link href="https://forum.rebol.info/stylesheets/desktop_e71c7b3a0694e7f6434c54a663bfb42821f8bd81.css?__ws=forum.rebol.info" media="all" rel="stylesheet" data-target="desktop" />
    
    
        <link rel="alternate" type="application/rss+xml" title="RSS feed of &#39;Switching to Stackless: Why this, Why now?&#39;" href="../1247.rss" />
    <meta property="og:site_name" content="AltRebol" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:image" content="https://forum.rebol.info/uploads/default/original/1X/ae4ccad1a2789bb1e85cf5a0f52f2f1de10da26d.png" />
<meta property="og:image" content="https://forum.rebol.info/uploads/default/original/1X/ae4ccad1a2789bb1e85cf5a0f52f2f1de10da26d.png" />
<meta property="og:url" content="https://forum.rebol.info/t/switching-to-stackless-why-this-why-now/1247/7" />
<meta name="twitter:url" content="https://forum.rebol.info/t/switching-to-stackless-why-this-why-now/1247/7" />
<meta property="og:title" content="Switching to Stackless: Why this, Why now?" />
<meta name="twitter:title" content="Switching to Stackless: Why this, Why now?" />
<meta property="og:description" content="Stackless went pretty well in terms of core design, and showed off generators and coroutines.  These seem like non-negotiable features to me, when most of the competition has them (as with multiple returns...)  But something about huge systemic overhauls that affect every part of the system is that they make you look at every part of the system.  This same problem happened with UTF-8 everywhere, when I was fairly overwhelmed trying to work on it.  So I took a break for some months, then came ba..." />
<meta name="twitter:description" content="Stackless went pretty well in terms of core design, and showed off generators and coroutines.  These seem like non-negotiable features to me, when most of the competition has them (as with multiple returns...)  But something about huge systemic overhauls that affect every part of the system is that they make you look at every part of the system.  This same problem happened with UTF-8 everywhere, when I was fairly overwhelmed trying to work on it.  So I took a break for some months, then came ba..." />
<meta property="article:published_time" content="2020-09-26T19:30:21+00:00" />
<meta property="og:ignore_canonical" content="true" />



    
  </head>
  <body class="crawler">
    
    <header>
      <a href="https://forum.rebol.info/">
          <img src="../../../uploads/default/original/1X/ae4ccad1a2789bb1e85cf5a0f52f2f1de10da26d.png" alt="AltRebol" id="site-logo" style="max-width: 150px;">
      </a>
    </header>
    <div id="main-outlet" class="wrap">
        <div id="topic-title">
    <h1>
      <a href="../1247.html">Switching to Stackless: Why this, Why now?</a>
    </h1>

      <div class="topic-category" itemscope itemtype="http://schema.org/BreadcrumbList">
          <span itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
            <a href="https://forum.rebol.info/c/development/8" class="badge-wrapper bullet" itemprop="item">
              <span class='badge-category-bg' style='background-color: #25AAE2'></span>
              <span class='badge-category clear-badge'>
                <span class='category-name' itemprop='name'>Development</span>
              </span>
            </a>
            <meta itemprop="position" content="1" />
          </span>
          <span itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
            <a href="../../../c/development/internals.html" class="badge-wrapper bullet" itemprop="item">
              <span class='badge-category-bg' style='background-color: #25AAE2'></span>
              <span class='badge-category clear-badge'>
                <span class='category-name' itemprop='name'>Internals</span>
              </span>
            </a>
            <meta itemprop="position" content="2" />
          </span>
      </div>

  </div>

  


      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="http://schema.org/Organization">
            <meta itemprop='name' content='AltRebol'>
              <div itemprop='logo' itemscope itemtype="http://schema.org/ImageObject">
                <meta itemprop='url' content='https://forum.rebol.info/uploads/default/original/1X/ae4ccad1a2789bb1e85cf5a0f52f2f1de10da26d.png'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
            <a itemprop="url" href='https://forum.rebol.info/u/hostilefork'><span itemprop='name'>hostilefork</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="../1247.html">


          <span class="crawler-post-infos">
              <meta itemprop='datePublished' content='2019-12-06T09:43:47Z'>
              <time itemprop='dateModified' datetime='2019-12-06T09:48:54Z' class='post-time'>
                December 6, 2019,  9:48am
              </time>
          <span itemprop='position'>#1</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <p>I wanted to write a short explanation about why switching Rebol to a stackless implementation--similar to <a href="https://en.wikipedia.org/wiki/Stackless_Python">Stackless Python</a>--has jumped itself up in the priority queue, to something I'm working on in the near term.</p>
<p>It's not a frivolous feature.  It's because:</p>
<ul>
<li>
<p><strong>the Wasm build broke</strong>.  The patch I made to "fix" it means that if you say <code>foo: func [] [foo]</code> and run it, you will irrevocably crash the web REPL.</p>
</li>
<li>
<p><strong>Wasm was <em>allowed</em> to break it</strong>.  There is nothing in the C standard for being able to predict a stack overflow, and the method R3-Alpha had been using was <a href="https://github.com/metaeducation/ren-c/blob/f20ac1f8f562e1a8ea9b038789976a39d99a9f7e/src/include/sys-stack.h#L159">knowingly non-standard</a>.  It was a bit of a thorn in my side--given how much care was taken in general to be on the right side of the standard...so I was always hoping for a better answer to come along.</p>
</li>
<li>
<p><strong>size optimization was eating stack</strong>.  We like to use emscripten's best options for making a small library.  But when we do, clang and emscripten avoid inlining...and instead choose to leave the functions as-is and make a lot of function calls.  With inlining disabled, Ren-C uses a fair number of function calls per evaluation step, and that competes with the JavaScript call stack...we were getting stack overflows not just on infinite recursions, but also seemingly not-too-deep routines (that didn't even have to be recursive).</p>
</li>
</ul>
<p>So this has been a bit of a setback.  It took down the REPL site for a while and has involved a fair amount of mulling about what to do.</p>
<h2>Can We Just Crash On StackOverflows for Now and Press On?</h2>
<p>We could put in a recursion counter and call that good enough...like old CPython does.</p>
<p>But...the problem with pressing on when you know something is wrong, is that there's some fairly deep impact on how the system and APIs work.  If enough groundwork isn't laid to know where the stackless influence is, we might write bad extensions or interoperability that fundamentally won't work later.</p>
<p>Not only that, we don't want to look bad against the competition.  As remarked in the motivations section for Stackless Python's <a href="http://www.stackless.com/spcpaper.htm#_Toc470444066">"Why the C Stack Should Vanish"</a>, they give a number of points, one of which is:</p>
<blockquote>
<p><em>"<strong>PERL has already no longer a C stack.</strong> They will have some good reasons for this. Python has no reason to be limited and stay behind."</em></p>
</blockquote>
<p>We can take some shortcuts.  Full stackless operation won't ever be possible if you call out of Rebol.  Each transition from Rebol into code that calls back into Rebol without deferring its stack back will not be stackless.  So if some Rebol natives fall into this category as well for a while, that's okay.  I will likely find a balance point that is "good enough" and leave a lot of natives to be converted on an as-needed basis.</p>
<h2>Why Wasn't Stackless Ren-C on the Agenda Before?</h2>
<p>I was always contemplating this direction.  So while it will be by no means trivial to switch, the design of frames and basic fabric of the interpreter should afford bending that way more than if I hadn't.  Preliminary tests are promising that conversion should progress at a decent pace.</p>
<p>One reason I'd avoided making a commitment to a stackless approach was because I felt it could be obfuscating when debugging the interpreter--and that such obfuscation would run counter to the "keep it simple" Amish principles.  It's nice when you can fire into the C debugger and scroll through the C stack frames and see things like code for a native "CASE" statement right there...with the execution point in the middle on the branch it's running right now.  A stackless interpreter has its state in data structures that aren't the C stack, and inspecting those data structures is a bit less intuitive.</p>
<p>As an alternative to stacklessness: I imagined that the platforms C programs were built on would be able to build a costing model to where a recursion could reliably predict if it would overflow (so long as it wasn't calling 3rd party code).  Then your program wouldn't be stuck in the situation of simulating a stack to protect itself from the C one it <em>should</em> be able to take for granted.  It would ask the C runtime if there was space for a recursion, and it would have a measurement for the worst-case cost of that function and tell you yes or no--as it might tell you that it couldn't malloc() a certain amount of memory from the heap, so you can raise an error.</p>
<p>But it seems indeed this was just in my imagination.  Guarantees about the stack aren't on anyone's agenda in the C world; so it's the job of the higher levels like Rebol or Python or whoever to worry about it.  So long as Ren-C is written in... C (or anything like it in the systems world), stack overflows are unpredictable and you must just find a way to bound your stack use if it's important.</p>
<h2>What Happened To Make Wasm Stack Detection Fail?</h2>
<p>While I haven't dug into all the details, the basic understanding is Emscripten jumped to a new version of Clang, which had a new extension model.  Emscripten could then integrate more deeply in the compilation process.  So instead of just getting a blob of output from the compiler and transforming it after-the-fact, they could add more intelligence to the code generation process.</p>
<p>The biggest obvious feature we got is that if your browser doesn't have shared memory or threads, the workaround build got a <em>lot</em> better and faster.  The new method was "Bsyncify" (an update of an older deprecated technique called "Asyncify") that leapfrogged the Emterpreter to the point they deprecated it entirely.  It actually was not hard to get this workaround build tweaked and going, but <a href="https://groups.google.com/forum/#!msg/emscripten-discuss/5jcPS41at9M/9vA2abaCCQAJ">missing features in the threaded build</a> kept us using the old emscripten SDK for threading until those were sorted.</p>
<p>Fortunately: the threading features were added.  Unfortunately: after those feature kicked in, the resulting build didn't then run at all.  (And also unfortunately, debugging this stuff isn't easy.)</p>
<p>That's when I found out our problem turned out to be related to how Rebol detected stack overflow conditions.  <strong>And stack overflow errors turn out to be a tricky topic that is misunderstood by many programmers.</strong></p>
<h2>Once A Stack Overflow Happens, You Are Hosed</h2>
<p>C programmers know that a stack overflow error is not recoverable.  (Or at least, <a href="https://stackoverflow.com/questions/427209/is-it-possible-to-predict-a-stack-overflow-in-c-on-linux/431024#comment104098846_431024">they <em>should</em> know</a>.)  But people using other languages are under the impression that they can catch them and do something meaningful, when they cannot do so in any general sense:</p>
<aside class="onebox stackexchange">
  <header class="source">
      <a href="https://stackoverflow.com/questions/58908855/what-if-any-javascript-operations-are-guaranteed-not-to-cause-stackoverflow-ra" target="_blank" rel="noopener">stackoverflow.com</a>
  </header>
  <article class="onebox-body">
      <a href="https://stackoverflow.com/users/211160/hostilefork-says-dont-trust-se" target="_blank" rel="noopener">
    <img alt="HostileFork says dont trust SE" src="https://i.stack.imgur.com/VWHTU.png?s=128&amp;g=1" class="thumbnail onebox-avatar" width="128" height="128">
  </a>
<h4>
  <a href="https://stackoverflow.com/questions/58908855/what-if-any-javascript-operations-are-guaranteed-not-to-cause-stackoverflow-ra" target="_blank" rel="noopener">What (if any) JavaScript operations are guaranteed not to cause stackoverflow RangeErrors?</a>
</h4>

<div class="tags">
  <strong>javascript, language-lawyer, stack-overflow, webassembly</strong>
</div>

<div class="date">
  asked by
  
  <a href="https://stackoverflow.com/users/211160/hostilefork-says-dont-trust-se" target="_blank" rel="noopener">
    HostileFork says dont trust SE
  </a>
  on <a href="https://stackoverflow.com/questions/58908855/what-if-any-javascript-operations-are-guaranteed-not-to-cause-stackoverflow-ra" target="_blank" rel="noopener">06:10AM - 18 Nov 19 UTC</a>
</div>

  </article>
  <div class="onebox-metadata">
    
    
  </div>
  <div style="clear: both"></div>
</aside>

<p>Sensibly, Rebol didn't try to install strange hooks to let C code badly "recover" from an actual stack overflow error.  It tried to conservatively guess about how close you <em>probably</em> were to the stack's limit...and pre-emptively generated an error.  On most people's machines, this was good enough to not crash the interpreter, but give you an error:</p>
<pre><code>&gt;&gt; foo: func [] [foo]
&gt;&gt; foo
** Internal Error: Stack overflow
</code></pre>
<p>Though "recovery" has all the same problems you can see in the JavaScript question I ask.  A lot of what people experience as "Rebol the language" is written in Rebol.  You don't know what mezzanine might have crashed, and if crashing that has left the system in an unstable or unusable state.  Bulletproofing all of the system against this...is hard.</p>
<h2>Well, There's Some of the Motivation</h2>
<p>Early tinkering has been promising...though this really does muck with the <a href="../../very-creaky-but-still-interesting-debug-step-demo/1154.html">primordial debugger</a>.  But it's good to have that debugger in there so that it doesn't get lost in the shuffle while considering this.</p>
<p>One thing about Stackless Python is seeing how they use pluggable evaluator functions which can become part of the stackless approach.  That's good, because this ties into how we can have a stackless parse.  Previously it might have been seen as bad that Ren-C was roping in the frame system used by the evaluator and debugger for each PARSE recursion due to inefficiency and eating more stack--but this should address any concerns from that.</p>
        </div>

        <meta itemprop='headline' content='Switching to Stackless: Why this, Why now?'>
          <meta itemprop='keywords' content=''>

        <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="1" />
           <span class='post-likes'>1 Like</span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="1" />
          </div>

            <div class='crawler-linkback-list' itemscope itemtype='http://schema.org/ItemList'>
                  <div itemprop='itemListElement' itemscope itemtype='http://schema.org/ListItem'>
                    <a href="../../pros-and-cons-of-the-pthread-web-build/1425/2.html" itemscope itemtype='http://schema.org/DiscussionForumPosting' itemprop='item'>
                      <meta itemprop='url' content='https://forum.rebol.info/t/pros-and-cons-of-the-pthread-web-build/1425/2'>
                      <span itemprop='name'>Pros and Cons of the Pthread Web Build</span>
                    </a>
                    <meta itemprop='position' content='9'>
                  </div>
                  <div itemprop='itemListElement' itemscope itemtype='http://schema.org/ListItem'>
                    <a href="../../foresight-in-2020-and-2019-retrospective/1258.html" itemscope itemtype='http://schema.org/DiscussionForumPosting' itemprop='item'>
                      <meta itemprop='url' content='https://forum.rebol.info/t/foresight-in-2020-and-2019-retrospective/1258'>
                      <span itemprop='name'>Foresight in 2020 (and 2019 Retrospective)</span>
                    </a>
                    <meta itemprop='position' content='10'>
                  </div>
                  <div itemprop='itemListElement' itemscope itemtype='http://schema.org/ListItem'>
                    <a href="../../semantics-of-read-and-tcp-streams-past-and-future/1733.html" itemscope itemtype='http://schema.org/DiscussionForumPosting' itemprop='item'>
                      <meta itemprop='url' content='https://forum.rebol.info/t/semantics-of-read-and-tcp-streams-past-and-future/1733'>
                      <span itemprop='name'>Semantics of READ and TCP Streams: Past And Future</span>
                    </a>
                    <meta itemprop='position' content='11'>
                  </div>
                  <div itemprop='itemListElement' itemscope itemtype='http://schema.org/ListItem'>
                    <a href="../../ren-c-license-changed-to-lgpl-3-0/1342.html" itemscope itemtype='http://schema.org/DiscussionForumPosting' itemprop='item'>
                      <meta itemprop='url' content='https://forum.rebol.info/t/ren-c-license-changed-to-lgpl-3-0/1342'>
                      <span itemprop='name'>Ren-C License Changed to LGPL 3.0</span>
                    </a>
                    <meta itemprop='position' content='12'>
                  </div>
                  <div itemprop='itemListElement' itemscope itemtype='http://schema.org/ListItem'>
                    <a href="../../cggong/1776/18.html" itemscope itemtype='http://schema.org/DiscussionForumPosting' itemprop='item'>
                      <meta itemprop='url' content='https://forum.rebol.info/t/cggong/1776/18'>
                      <span itemprop='name'>Cggong</span>
                    </a>
                    <meta itemprop='position' content='13'>
                  </div>
            </div>
      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="http://schema.org/Organization">
            <meta itemprop='name' content='AltRebol'>
              <div itemprop='logo' itemscope itemtype="http://schema.org/ImageObject">
                <meta itemprop='url' content='https://forum.rebol.info/uploads/default/original/1X/ae4ccad1a2789bb1e85cf5a0f52f2f1de10da26d.png'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
            <a itemprop="url" href='https://forum.rebol.info/u/hostilefork'><span itemprop='name'>hostilefork</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="../1247.html">


          <span class="crawler-post-infos">
              <meta itemprop='datePublished' content='2020-04-25T18:30:28Z'>
              <time itemprop='dateModified' datetime='2020-04-25T20:23:40Z' class='post-time'>
                April 25, 2020,  8:23pm
              </time>
          <span itemprop='position'>#2</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <p>Because I don't care much for keeping secrets, I'll mention that the "big" thing I am working on is Stackless.  <strong>This is probably the biggest single change the codebase will have seen in a long time.</strong></p>
<p>It requires a fundamental change to how natives are written in C.  Previously anything that invoked the evaluator--such as Rebol's WHILE--would begin running C code that implemented that construct, and not execute a C <code>return</code> statement until all the looping was done.  Clearly that means that if you put another Rebol WHILE inside of a while loop, you would have multiple C stacks for the native while in effect at a time.  This is a recipe for growing the C stack arbitrarily deep, in proportion to how deep the  Rebol stack is.</p>
<p>The new world requires every native to become a kind of state machine.  It will run a C <code>return</code> every time it wants an evaluation...returning not a result, but a request for the evaluator to do that thing and call it back.  This state machine has to retain memory of what the last thing it did was... did it ask to run a condition, or did it ask to run a body?  Because what it does with the result will depend on that.  After many times of <code>return</code>-ing to the evaluator with requests, it will ultimately return a signal of an <em>actual</em> result when the loop condition is false, or when there is a BREAK.</p>
<h2>The More I Work On This, The More Essential It Feels</h2>
<p>The legacy "CPython" implementation strongly paralleled historical Rebol and Red in how its interpreter recursed.  Modern interpreters are rejecting this notion; the arguments are made clearly for why.  When I notice things JavaScript can do with ease that we cannot, <em>I can't allow them to have that edge</em>.  The same goes for Perl, Python, or Ruby: when the comparisons are direct, it does not pay to anchor one's ship to a method that is destined to fail.</p>
<p>The ramifications are deep.  Yet as intimidating as it is to face a mountain of a task like this, I do not feel someone can announce an "interpreted language of the future" which is missing this key advancement.</p>
<p>From reading the reports on Stackless Python it sounds like it took a year to do.  I don't know how long it will take.   What I can report is that there have been some early successes.  Even though the exploration of the consequences are making the code a bit haphazard-seeming, strong defensive programming is keeping things running...hopefully well enough to let design improvements take shape so it tidies up.</p>
<p>With this being such a clear imperative, I don't see how it couldn't be attacked before going after the deep-reaching features like debuggers and tracers.  In my opinion the language will never truly be learnable unless it has a full and flexible debugger--so this is why I've moved into operating on my instincts of what is right now the highest priority.</p>
        </div>

        <meta itemprop='headline' content='Switching to Stackless: Why this, Why now?'>

        <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="2" />
           <span class='post-likes'>2 Likes</span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="0" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="http://schema.org/Organization">
            <meta itemprop='name' content='AltRebol'>
              <div itemprop='logo' itemscope itemtype="http://schema.org/ImageObject">
                <meta itemprop='url' content='https://forum.rebol.info/uploads/default/original/1X/ae4ccad1a2789bb1e85cf5a0f52f2f1de10da26d.png'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
            <a itemprop="url" href='https://forum.rebol.info/u/BlackATTR'><span itemprop='name'>BlackATTR</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="../1247.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2020-04-26T17:31:53Z' class='post-time'>
                April 26, 2020,  5:31pm
              </time>
              <meta itemprop='dateModified' content='2020-04-26T17:31:53Z'>
          <span itemprop='position'>#3</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <p>This sounds intense. Good luck <a class="mention" href="https://forum.rebol.info/u/hostilefork">@hostilefork</a>, you're the right person for the challenge!</p>
        </div>

        <meta itemprop='headline' content='Switching to Stackless: Why this, Why now?'>

        <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="1" />
           <span class='post-likes'>1 Like</span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="1" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="http://schema.org/Organization">
            <meta itemprop='name' content='AltRebol'>
              <div itemprop='logo' itemscope itemtype="http://schema.org/ImageObject">
                <meta itemprop='url' content='https://forum.rebol.info/uploads/default/original/1X/ae4ccad1a2789bb1e85cf5a0f52f2f1de10da26d.png'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
            <a itemprop="url" href='https://forum.rebol.info/u/hostilefork'><span itemprop='name'>hostilefork</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="../1247.html">


          <span class="crawler-post-infos">
              <meta itemprop='datePublished' content='2020-05-24T02:44:02Z'>
              <time itemprop='dateModified' datetime='2020-05-24T04:24:21Z' class='post-time'>
                May 24, 2020,  4:24am
              </time>
          <span itemprop='position'>#4</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <p>Wanted to give a small status report.  <strong>Things are advancing a bit each day...painfully, but semi-clearly.</strong></p>
<ul>
<li>
<p>The good news of having Ren-C entering this with such a wide range of wild abilities is that the design is very <em>informed</em>.  So far, no previous fun-and-cool features look like they're going to get the axe because of the imposition of new architecture.  <em>It seems to be a strictly-enabling change.</em>  Even though it certainly throws some of the old ideas about how to write a debugger out the window...those ideas were rickety.  And I see ways in which it will really empower new methods.  I just have to see the rest.</p>
</li>
<li>
<p>Nothing is firmed up enough to where it's productive to start doing formal timing.  However...no doubt some of the stackless operations are going to come with extra cost.  But when I look at the kinds of convolutions you'd have to do to achieve these goals without them as interpreter features...it reminds me not to be <em>"penny-wise and pound-foolish"</em>.  Powerful operations that help you avoid writing huge and broken usermode surrogates that are MUCH slower can win in the big picture... so sacrificing a couple of micro-optimizations is <img src="../../../images/emoji/twitter/ok.png%3Fv=9" title=":ok:" class="emoji" alt=":ok:">  <sub><a href="../../the-now-even-more-special-specialize/588.html">see also the old SPECIALIZE performance comparison notes</a></sub></p>
</li>
</ul>
<p>By doing things like tackling PARSE and TRAP+FAIL early on, I'm not avoiding hard questions and just going around converting all the easy natives to stackless first.  I'm pacing them out (e.g. I just did LOOP and UNTIL today, which took only minutes each.)  Doing a couple at a time helps me let each instance of returning to it be a "new" experience where I might have new insights.</p>
<p>The three biggest unknowns right now are:</p>
<ul>
<li>
<p><strong>Debugging</strong> - It's very much on my mind to create an experience that's not just like the hacked up demo I did...but real.  I want it to be better, with real automation and reflection.  It's been a trickier thing than I first imagined to design a pleasing/extensible debugger in a non-threaded environment running in the same language it is debugging (!).</p>
</li>
<li>
<p><strong>Path Dispatch</strong> - which was always weird and now has to be redone.  And not that I anticipate getting something as bad as history's method would be hard (it seems to be another one of Rebol's semantics-free-zones).  Hence what worries me about it that if I'm going to bother doing a full rewrite...I'd kind of like to make some headway on pinning down <em>just what the heck is it</em>.  How is it generic, or safe, or how does it apply to custom types.  I may have to kick that can down the road again and just focus on making it stackless.</p>
</li>
<li>
<p><strong>Performance</strong> - I've been applying intuition to it but it's going to need some looking at with instrumentation and timings.  We've spoken about performance regression testing...and it seems like the web automation demo via headless Firefox might be not just the most relevant target, but the most easy to get comparison figures for.</p>
</li>
</ul>
<p>I started this around 18-Apr so it's been a bit over a month.    It's a little hard to estimate how fast progress will be, especially in these three areas.  But pure stackless processing is probably not more than a couple of months away; with less clear progress on debugging or guarantees about how fast it will be.</p>
<p>In any case, it looks like I might be on the cusp of another relocation shortly. <img src="../../../images/emoji/twitter/palm_tree.png%3Fv=9" title=":palm_tree:" class="emoji" alt=":palm_tree:">  <img src="../../../images/emoji/twitter/oncoming_automobile.png%3Fv=9" title=":oncoming_automobile:" class="emoji" alt=":oncoming_automobile:"> <img src="../../../images/emoji/twitter/palm_tree.png%3Fv=9" title=":palm_tree:" class="emoji" alt=":palm_tree:">  So we'll see if that increases or decreases productivity.</p>
        </div>

        <meta itemprop='headline' content='Switching to Stackless: Why this, Why now?'>

        <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="4" />
           <span class='post-likes'>4 Likes</span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="1" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="http://schema.org/Organization">
            <meta itemprop='name' content='AltRebol'>
              <div itemprop='logo' itemscope itemtype="http://schema.org/ImageObject">
                <meta itemprop='url' content='https://forum.rebol.info/uploads/default/original/1X/ae4ccad1a2789bb1e85cf5a0f52f2f1de10da26d.png'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
            <a itemprop="url" href='https://forum.rebol.info/u/hostilefork'><span itemprop='name'>hostilefork</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="../1247.html">


          <span class="crawler-post-infos">
              <meta itemprop='datePublished' content='2020-07-07T20:51:35Z'>
              <time itemprop='dateModified' datetime='2020-07-07T20:52:46Z' class='post-time'>
                July 7, 2020,  8:52pm
              </time>
          <span itemprop='position'>#5</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <p>So we have witnessed the first successfully trapped stack overflow error in the Wasm build (both Asyncify and Threaded).  This required switching it to the <code>ABORTING_MALLOC=0</code> build setting...because by default, Emscripten assumes a failing malloc() should kill your program instead of return NULL.</p>
<p>As this shows, the "stack overflow" error manifested as running out of memory:</p>
<pre><code>&gt;&gt; recursive: func [] [array: copy [a b c] recursive]

&gt;&gt; recursive
** Internal Error: not enough memory
</code></pre>
<p>I included a COPY to make the point that when you overflow in a "stackless" system, you won't necessarily run out of memory on the attempt to allocate a stack frame.  When stack frames are consuming heap/pooled memory just like everything else, it's just as likely that the COPY to make a new array will be the trigger as trying to allocate a new frame.</p>
<p>You may notice that there's no stack frame list to hint you at the deep recursion being the cause of the problem.  That's because when you run out of memory and are trying to present an error, you can't be guaranteed to have enough memory to allocate an array for this purpose.  Similarly, you can't expect to be able to allocate the object to represent the error itself.  These must be preallocated at some size.  That's all additional work that needs to be done, that had never been done (as Rebol never really handled out of memory errors rigorously).</p>
<p>I have removed the C_STACK_OVERFLOWING() check which happened when you pushed function calls.  <a href="https://github.com/metaeducation/ren-c/blob/4bec24a4ade8259f9fa1bfafbaf1825ca1b20160/src/include/sys-stack.h#L159" rel="nofollow noopener">To revisit a writeup on why it was bad, consult the comments.</a>  The tests have been adapted so that all the "infinite" tests currently just throw after some large number of recursions, and they complete.</p>
<p>BUT... the evaluator and function calls are not the only place that C_STACK_OVERFLOWING() was used to detect deep recursions.  Other operations like scanning, molding, binding, etc. used C stack recursions, and for deeply nested blocks this could overflow.  Also, not all such operations were protected.  Here's a list of the other clients of C_STACK_OVERFLOWING:</p>
<ul>
<li>
<p><strong>Binding</strong> - Binding is currently implemented as a native that calls a C function, which is "C-recursive"... that C function calls itself for as deep as the block structure it is binding is.  With a sufficiently deep block, this could cause an "untrappable" stack overflow.  One way to attack this is to make each bind level create a frame...as is done with stackless COMPOSE, that uses a "Binding Executor".  While this may sound like it would be slow, running through common code paths would incentivize optimizations that would--in turn--speed up the whole evaluator, PARSE, etc.</p>
</li>
<li>
<p><strong>Copying</strong> - There are many different forms of copying and options while doing so.  Things like "relativizing" blocks are weaved in with the copying process...and one can imagine tying it in with binding as well.  In any case, the core of copying is currently something called "clonification" which uses C_STACK_OVERFLOWING.  It's not as obvious to me just by looking at it how this code could use the trampoline to power it... but it's likely possible.</p>
</li>
<li>
<p><strong>Comparing</strong> - The general topic of comparison semantics in Rebol is rather neglected, but it's yet another routine that is done through plain recursions.  It seems to be something amenable to frame-based recursion.</p>
</li>
<li>
<p><strong>Scanning</strong> - If you imagine writing something like <strong>load "[[[[[[[[[[[[[..."</strong> there is going to be a limit somewhere.  Red seems to use a specialized stack for this vs. doing recursions (the error you get for deep scans is <code>PARSE - stack limit reached</code>, and not a typical <code>stack overflow</code>).  But Rebol's scanner was based on plain C recursion.  I again wonder just how generic and fast the "trampoline" could be engineered to be, to where it would be close enough to as fast to be worth it vs. a specialized stack.</p>
</li>
<li>
<p><strong>Molding</strong> - Another C recursive routine, which might be reframable to use the trampoline.  As with most of these routines that use C recursions, there has to be some concern over dealing with cycles.  Another wrench thrown in is that within the system, molding is designed to work on so-called "Relative" values, which users never see but are part of the implementation.  This means that if all the C parts in the system tried to call a native MOLD, they would not have the proper bit patterns to give as a fulfilled value.  :-/</p>
</li>
</ul>
<p>So that's a little map of some of the parts of the code that could trip up with stack overflows when given a sufficiently pathological data structure.  This isn't about operating on <em>big</em> data structures, just deep ones.</p>
<p>I'm not really as concerned about these deep-datastructure recursions as I am about having a story for the debugger in this stackless world, and a bunch of bigger questions.</p>
<p>Also, while stackless is coming along, it's likely the biggest single change ever done (previous competitors: specific binding, UTF-8 Everywhere).  So it's probably healthier to take breaks and mix in other things.</p>
        </div>

        <meta itemprop='headline' content='Switching to Stackless: Why this, Why now?'>

        <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="2" />
           <span class='post-likes'>2 Likes</span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="1" />
          </div>

            <div class='crawler-linkback-list' itemscope itemtype='http://schema.org/ItemList'>
                  <div itemprop='itemListElement' itemscope itemtype='http://schema.org/ListItem'>
                    <a href="../../comparison-semantics/1318.html" itemscope itemtype='http://schema.org/DiscussionForumPosting' itemprop='item'>
                      <meta itemprop='url' content='https://forum.rebol.info/t/comparison-semantics/1318'>
                      <span itemprop='name'>Comparison Semantics</span>
                    </a>
                    <meta itemprop='position' content='2'>
                  </div>
            </div>
      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="http://schema.org/Organization">
            <meta itemprop='name' content='AltRebol'>
              <div itemprop='logo' itemscope itemtype="http://schema.org/ImageObject">
                <meta itemprop='url' content='https://forum.rebol.info/uploads/default/original/1X/ae4ccad1a2789bb1e85cf5a0f52f2f1de10da26d.png'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
            <a itemprop="url" href='https://forum.rebol.info/u/BlackATTR'><span itemprop='name'>BlackATTR</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="../1247.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2020-07-07T22:02:37Z' class='post-time'>
                July 7, 2020, 10:02pm
              </time>
              <meta itemprop='dateModified' content='2020-07-07T22:02:37Z'>
          <span itemprop='position'>#6</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <p>Impressive progress <a class="mention" href="https://forum.rebol.info/u/hostilefork">@hostilefork</a></p>
        </div>

        <meta itemprop='headline' content='Switching to Stackless: Why this, Why now?'>

        <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="0" />
           <span class='post-likes'></span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="0" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="http://schema.org/Organization">
            <meta itemprop='name' content='AltRebol'>
              <div itemprop='logo' itemscope itemtype="http://schema.org/ImageObject">
                <meta itemprop='url' content='https://forum.rebol.info/uploads/default/original/1X/ae4ccad1a2789bb1e85cf5a0f52f2f1de10da26d.png'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
            <a itemprop="url" href='https://forum.rebol.info/u/hostilefork'><span itemprop='name'>hostilefork</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="../1247.html">


          <span class="crawler-post-infos">
              <meta itemprop='datePublished' content='2020-09-26T19:30:21Z'>
              <time itemprop='dateModified' datetime='2020-09-27T01:20:36Z' class='post-time'>
                September 27, 2020,  1:20am
              </time>
          <span itemprop='position'>#7</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <aside class="quote no-group" data-post="1" data-topic="1247">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="https://forum.rebol.info/user_avatar/forum.rebol.info/hostilefork/40/26_2.png" class="avatar"> hostilefork:</div>
<blockquote>
<h2>Can We Just Crash On StackOverflows for Now and Press On?</h2>
<p>We could put in a recursion counter and call that good enough...like old CPython does.</p>
<p>But...the problem with pressing on when you know something is wrong, is that there's some fairly deep impact on how the system and APIs work. If enough groundwork isn't laid to know where the stackless influence is, we might write bad extensions or interoperability that fundamentally won't work later.</p>
</blockquote>
</aside>
<p>Stackless went pretty well in terms of core design, and showed off <a href="../../yielder-and-generator-and-thinking-about-coroutines/1311.html">generators and coroutines</a>.  These seem like non-negotiable features to me, when most of the competition has them (as with multiple returns...)</p>
<p>But something about huge systemic overhauls that affect every part of the system is that <strong>they make you look at every part of the system</strong>.  This same problem happened with UTF-8 everywhere, when I was fairly overwhelmed trying to work on it.  So I took a break for some months, then came back and applied it when it was ready.</p>
<p>The issue list of things I had to address that were unrelated to stackless were so long that it was demoralizing feeling like I couldn't proceed without fixing them.  I got fairly blocked.  In addition, I realized that coming to terms with the debugger model I wanted would require a lot of work.</p>
<p>Looking at other things unblocked me, and now I'm feeling progress is at a pretty good clip on solving a fair number of basic longstanding issues.</p>
<p>I'm not entirely sure about the timescale of particular features.  But what I like about how things are going now is that it's framing up comfortable decisions in the style that I had wanted for a Beta/One.  Taking care of "little things" like knowing how APPEND works w.r.t. splicing or how constness vs. mutability works is fundamental to being able to teach people things they don't have to unlearn, so I'm not begrudging myself time spent on it.</p>
<p>Stackless is still in mind, and changes accounting for it.</p>
        </div>

        <meta itemprop='headline' content='Switching to Stackless: Why this, Why now?'>

        <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="3" />
           <span class='post-likes'>3 Likes</span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="0" />
          </div>

      </div>






    </div>
    <footer class="container wrap">
      <nav class='crawler-nav'>
        <ul>
        <li itemscope itemtype='http://schema.org/SiteNavigationElement'>
          <span itemprop='name'>
            <a href='https://forum.rebol.info/' itemprop="url">Home </a>
          </span>
        </li>
        <li itemscope itemtype='http://schema.org/SiteNavigationElement'>
          <span itemprop='name'>
            <a href='https://forum.rebol.info/categories' itemprop="url">Categories </a>
          </span>
        </li>
        <li itemscope itemtype='http://schema.org/SiteNavigationElement'>
          <span itemprop='name'>
            <a href='https://forum.rebol.info/guidelines' itemprop="url">FAQ/Guidelines </a>
          </span>
        </li>
        <li itemscope itemtype='http://schema.org/SiteNavigationElement'>
          <span itemprop='name'>
            <a href='https://forum.rebol.info/tos' itemprop="url">Terms of Service </a>
          </span>
        </li>
        <li itemscope itemtype='http://schema.org/SiteNavigationElement'>
          <span itemprop='name'>
            <a href='https://forum.rebol.info/privacy' itemprop="url">Privacy Policy </a>
          </span>
        </li>
        </ul>
      </nav>
      <p class='powered-by-link'>Powered by <a href="https://www.discourse.org">Discourse</a>, best viewed with JavaScript enabled</p>
    </footer>
    
    
  </body>
  
</html>
